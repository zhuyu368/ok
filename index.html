<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¢¦è§’çˆ±äºº - ç§å¯†èŠå¤©</title>
<style>
/* ä¸»é¢˜è‰²å˜é‡ - å®Œå…¨ä¿ç•™ç¬¬äºŒä¸ªæ–‡ä»¶çš„æ‰€æœ‰CSS */
:root {
  --bg-main: #bfbfbf;
  --bg-panel: rgba(229, 229, 229, 0.85);
  --msg-self: #dedede;
  --msg-other: #f2f2f2;
  --text: #5c5c5c;
  --accent: #8a7f8d;
  --accent-light: #a99cad;
  --accent-gray: #9e9e9e;
  --accent-gray-light: #bdbdbd;
  --online: #4caf50;
  --busy: #ff9800;
  --dr: #2196f3;
  --cr: #9c27b0;
  --nearby: #ff5722;
  --mood-happy: #ffcc00;
  --mood-normal: #4caf50;
  --mood-sad: #9c27b0;
  --mood-angry: #f44336;
  --quote-bg: rgba(138, 127, 141, 0.1);
  --call-bg: rgba(33, 150, 243, 0.1);
  --call-text: #2196f3;
  --video-bg: rgba(156, 39, 176, 0.1);
  --video-text: #9c27b0;
  --tarot-bg: rgba(156, 39, 176, 0.1);
  --tarot-text: #7b1fa2;
}

/* åŸºç¡€æ ·å¼ - å®Œå…¨ä¿ç•™ç¬¬äºŒä¸ªæ–‡ä»¶çš„æ‰€æœ‰CSS */
body {
  margin: 0;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-main);
  background-image: radial-gradient(#ffffff55 2px, transparent 2px);
  background-size: 30px 30px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text);
  overflow: hidden;
  transition: background 0.5s ease;
}

/* èƒŒæ™¯å›¾ç‰‡å®¹å™¨ */
.background-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: opacity 0.5s ease;
}

/* ä¸»å®¹å™¨ */
.container {
  width: 100%;
  max-width: 900px;
  height: 90vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  padding: 15px;
  box-sizing: border-box;
  position: relative;
}

/* èŠå¤©å¤´éƒ¨åŒºåŸŸ */
.chat-header {
  width: 100%;
  max-width: 800px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
.user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 75px;
  cursor: pointer;
  position: relative;
}

/* ä¿®æ”¹ï¼šå¤´åƒæ ·å¼æ”¹ä¸ºçº¯ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— è¾¹æ¡† */
.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 3px;
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ä¿®æ”¹ï¼šç¡®ä¿å¤´åƒå†…å®¹ä¸ºç©º */
.avatar span {
  display: none;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* å¿ƒæƒ…æŒ‡æ•° */
.mood-percentage {
  font-size: 0.65rem;
  color: var(--text);
  margin-top: 2px;
  text-align: center;
  height: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
  position: absolute;
  top: 0;
  right: 10px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid var(--bg-panel);
  z-index: 2;
}

.status-indicator.online {
  background-color: var(--online);
}

.status-indicator.busy {
  background-color: var(--busy);
}

.status-indicator.dr {
  background-color: var(--dr);
}

.status-indicator.cr {
  background-color: var(--cr);
}

.status-indicator.nearby {
  background-color: var(--nearby);
}

/* çŠ¶æ€æ–‡å­— */
.status-text {
  font-size: 0.65rem;
  color: var(--text);
  opacity: 0.8;
  margin-top: 2px;
  text-align: center;
  height: 14px;
}

.nickname {
  font-size: 0.75rem;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text);
  margin-top: 3px;
}

/* èŠå¤©æ ‡é¢˜åŒºåŸŸ */
.chat-title-area {
  text-align: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 0;
  padding: 0 5px;
}

.chat-title-area h1 {
  margin: 0;
  font-weight: 300;
  font-size: 1.6rem;
  color: var(--accent);
  letter-spacing: 1px;
  line-height: 1.2;
}

.chat-subtitle {
  margin: 3px 0 0;
  font-size: 0.75rem;
  opacity: 0.8;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.love-days {
  margin-top: 5px;
  font-size: 0.7rem;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgba(138, 127, 141, 0.1);
  transition: all 0.2s;
  white-space: nowrap;
}

.love-days:hover {
  background: rgba(138, 127, 141, 0.2);
}

.love-days i {
  font-size: 0.75rem;
}

/* è®¾ç½®é½¿è½®æŒ‰é’® */
.settings-toggle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(138, 127, 141, 0.3);
  flex-shrink: 0;
}

.settings-toggle:hover {
  background: var(--accent-light);
  transform: rotate(30deg);
}

.settings-toggle i {
  color: white;
  font-size: 1.1rem;
}

/* èŠå¤©åŒºåŸŸ */
.chat-section {
  width: 100%;
  height: calc(100% - 120px);
  max-width: 800px;
  display: flex;
  flex-direction: column;
}

.chat-container {
  width: 100%;
  height: 100%;
  background: transparent;  
  backdrop-filter: none;    
  border-radius: 18px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 8px 4px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}

/* æ¶ˆæ¯å®¹å™¨ - åŒ…å«å¤´åƒå’Œæ¶ˆæ¯ */
.message-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  max-width: 100%;
}

.message-container.self {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid rgba(92, 92, 92, 0.2);
}

.message-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.message-content {
  max-width: 70%;
  display: flex;
  flex-direction: column;
  position: relative;
}

.message-container.self .message-content {
  align-items: flex-end;
}

.message-container.other .message-content {
  align-items: flex-start;
}

/* æ¶ˆæ¯æ ·å¼ */
.message {
  max-width: 100%;
  padding: 8px 12px;
  border-radius: 16px;
  line-height: 1.4;
  word-wrap: break-word;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  font-size: 0.9rem;
  position: relative;
  cursor: pointer;
  transition: background-color 0.2s;
}

.message:hover {
  opacity: 0.95;
}

.message.self {
  background: var(--msg-self);
  border-bottom-right-radius: 4px;
}

.message.other {
  background: var(--msg-other);
  border-bottom-left-radius: 4px;
}

.message-time {
  font-size: 0.65rem;
  opacity: 0.6;
  margin-top: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
}

/* ä¿®æ”¹ï¼šæ¶ˆæ¯æ“ä½œèœå•æ ·å¼ä¼˜åŒ– */
.message-actions {
  position: absolute;
  top: -40px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  display: none;
  flex-direction: row;
  z-index: 10;
  overflow: hidden;
  padding: 2px;
}

.message-container.self .message-actions {
  right: 0;
}

.message-container.other .message-actions {
  left: 0;
}

/* ä¿®æ”¹ï¼šæ“ä½œæŒ‰é’®å˜å¤§å¹¶ä½¿ç”¨ç°è‰²ä¸»é¢˜ */
.message-action-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  color: var(--accent-gray);
  border-radius: 6px;
  margin: 2px;
}

.message-action-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  transform: translateY(-1px);
}

/* æ‰€æœ‰æ“ä½œæŒ‰é’®ç»Ÿä¸€ä½¿ç”¨ç°è‰²ä¸»é¢˜ */
.message-action-btn.delete {
  color: var(--accent-gray);
}

.message-action-btn.quote {
  color: var(--accent-gray);
}

.message-action-btn.recall {
  color: var(--accent-gray);
}

/* æ¶ˆæ¯çŠ¶æ€ */
.message-status {
  display: flex;
  align-items: center;
  gap: 2px;
  font-size: 0.65rem;
}

.status-check {
  font-size: 0.8rem;
}

.status-check.single {
  color: #888;
}

.status-check.double {
  color: var(--accent);
}

/* å·²è¯»ä¸å›æç¤º */
.read-no-reply {
  color: var(--busy);
  font-size: 0.65rem;
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 3px;
}

/* å¼•ç”¨æ¶ˆæ¯æ ·å¼ */
.quoted-message {
  background: var(--quote-bg);
  padding: 6px 8px;
  border-radius: 8px;
  margin-bottom: 6px;
  border-left: 3px solid var(--accent);
  font-size: 0.8rem;
  opacity: 0.9;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
}

.quoted-message img {
  max-height: 20px;
  border-radius: 4px;
  vertical-align: middle;
  margin-right: 4px;
}

/* å¯¹æ–¹æ­£åœ¨è¾“å…¥åŠ¨ç”» */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  background: var(--msg-other);
  border-radius: 16px;
  align-self: flex-start;
  max-width: 130px;
  margin-bottom: 4px;
  opacity: 0;
  transition: opacity 0.3s;
  margin-left: 40px;
  font-size: 0.8rem;
}

.typing-indicator.active {
  opacity: 1;
}

.typing-indicator .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: var(--text);
  opacity: 0.4;
  animation: typingAnimation 1.5s infinite ease-in-out;
}

.typing-indicator .dot:nth-child(1) {
  animation-delay: 0s;
}

.typing-indicator .dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator .dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingAnimation {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.4;
  }
  30% {
    transform: translateY(-4px);
    opacity: 0.8;
  }
}

/* è¾“å…¥åŒºåŸŸ */
.input-area {
  display: flex;
  gap: 8px;
  align-items: flex-end;
  position: relative;
}

/* ä¿®æ”¹ï¼šç¼©çŸ­è¾“å…¥æ¡† */
.message-input {
  flex: 1;
  min-width: 200px;
  padding: 12px 16px;
  border: none;
  border-radius: 22px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.9rem;
  color: var(--text);
  outline: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.message-input:focus {
  background: rgba(255, 255, 255, 0.9);
}

/* è¾“å…¥åŒºåŸŸæŒ‰é’®å®¹å™¨ */
.input-area-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: nowrap;
}

/* ä¿®æ”¹ï¼šå°†å‘é€æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.send-button {
  padding: 12px 20px;
  border: none;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.3);
  white-space: nowrap;
}

.send-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

.send-button:active {
  transform: translateY(0);
}

/* ä¿®æ”¹ï¼šå°†"ç»§ç»­"æŒ‰é’®æ”¹ä¸º"..."å›¾æ¡ˆçš„ç°è‰²æŒ‰é’® */
.continue-button {
  width: 44px;
  height: 44px;
  padding: 0;
  border: none;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.continue-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

/* ä¿®æ”¹ï¼šå°†å›¾ç‰‡ä¸Šä¼ æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.upload-image-button {
  width: 44px;
  height: 44px;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.3);
  flex-shrink: 0;
}

.upload-image-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

.upload-image-button i {
  font-size: 1.2rem;
}

/* è®¾ç½®é¢æ¿ */
.settings-panel {
  position: fixed;
  top: 0;
  right: -450px;
  width: 420px;
  height: 100vh;
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
  transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.settings-panel.active {
  right: 0;
}

.settings-header {
  padding: 20px;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.settings-header h2 {
  margin: 0;
  font-weight: 400;
  color: var(--accent);
  font-size: 1.6rem;
}

.close-settings {
  background: none;
  border: none;
  font-size: 1.6rem;
  color: var(--text);
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close-settings:hover {
  opacity: 1;
  background: rgba(92, 92, 92, 0.1);
}

/* è®¾ç½®å†…å®¹åŒºåŸŸ */
.settings-content {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px 20px;
}

.settings-tabs {
  display: flex;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-button {
  flex: 1;
  padding: 12px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  font-size: 0.9rem;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  min-width: 80px;
}

.tab-button.active {
  border-bottom-color: var(--accent);
  color: var(--accent);
  font-weight: 500;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* è¡¨æƒ…åŒ…åº“åŒºåŸŸ */
.sticker-library h3,
.phrases-library h3,
.ratio-library h3,
.appearance-library h3,
.export-library h3,
.communication-library h3,
.cloud-library h3,
.background-library h3,
.tarot-library h3 {
  margin-top: 0;
  margin-bottom: 12px;
  font-weight: 400;
  color: var(--accent);
  font-size: 1.2rem;
}

.sticker-library p,
.phrases-library p,
.ratio-library p,
.appearance-library p,
.export-library p,
.communication-library p,
.cloud-library p,
.background-library p,
.tarot-library p {
  margin: 0 0 16px;
  font-size: 0.85rem;
  opacity: 0.8;
  line-height: 1.4;
}

.sticker-preview {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
  max-height: 250px;
  overflow-y: auto;
  padding: 4px;
}

.sticker-item {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px dashed rgba(92, 92, 92, 0.2);
  position: relative;
}

.sticker-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sticker-placeholder {
  font-size: 1.5rem;
  color: rgba(92, 92, 92, 0.3);
}

.delete-sticker {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.sticker-item:hover .delete-sticker {
  opacity: 1;
}

/* ä¿®æ”¹ï¼šå°†æ‰€æœ‰è®¾ç½®æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.add-sticker-btn,
.save-phrases-btn,
.export-btn,
.communication-btn,
.cloud-btn,
.save-background-btn,
.save-tarot-btn,
.format-btn,
.background-upload-btn,
.remove-background-btn,
.modal-btn.primary {
  display: block;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}

.add-sticker-btn:hover,
.save-phrases-btn:hover,
.export-btn:hover,
.communication-btn:hover,
.cloud-btn:hover,
.save-background-btn:hover,
.save-tarot-btn:hover,
.format-btn:hover,
.background-upload-btn:hover,
.remove-background-btn:hover,
.modal-btn.primary:hover {
  background: var(--accent-gray-light);
}

/* å­—å¡ç®¡ç†åŒºåŸŸ */
.phrases-textarea {
  width: 100%;
  height: 180px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
}

.phrases-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.phrases-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.7);
}

/* æ¯”ä¾‹è®¾ç½®åŒºåŸŸ */
.ratio-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.ratio-item {
  margin-bottom: 16px;
}

.ratio-item:last-child {
  margin-bottom: 0;
}

.ratio-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.ratio-slider {
  width: 100%;
  height: 5px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(92, 92, 92, 0.2);
  border-radius: 3px;
  outline: none;
}

.ratio-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.ratio-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.ratio-value {
  font-weight: 500;
  color: var(--accent);
}

.max-count-control,
.auto-send-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid rgba(92, 92, 92, 0.1);
}

.max-count-label,
.auto-send-label {
  font-size: 0.9rem;
}

.max-count-select,
.auto-send-select {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  background: rgba(255, 255, 255, 0.7);
  color: var(--text);
  font-size: 0.85rem;
  outline: none;
  width: 70px;
}

/* å¤–è§‚è®¾ç½®åŒºåŸŸ */
.appearance-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.appearance-item {
  margin-bottom: 16px;
}

.appearance-item:last-child {
  margin-bottom: 0;
}

.appearance-label {
  display: block;
  margin-bottom: 6px;
  font-size: 0.85rem;
  color: var(--text);
}

.appearance-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
  box-sizing: border-box;
}

.appearance-input:focus {
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.date-inputs {
  display: flex;
  gap: 8px;
  align-items: center;
}

.date-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
}

.date-input:focus {
  border-color: var(--accent);
}

/* å¯¼å‡ºè®¾ç½®åŒºåŸŸ */
.export-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.export-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.export-option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
}

.export-option label {
  font-size: 0.9rem;
  color: var(--text);
}

.export-formats {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.format-btn {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--accent-gray);
  border-radius: 8px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.format-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

/* é€šä¿¡è®¾ç½®åŒºåŸŸ */
.communication-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.communication-item {
  margin-bottom: 20px;
}

.communication-item:last-child {
  margin-bottom: 0;
}

.communication-label {
  display: block;
  margin-bottom: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text);
}

.communication-buttons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

/* ä¿®æ”¹ï¼šé€šè¯å’Œè§†é¢‘æŒ‰é’®æ”¹ä¸ºinsé»‘ç™½è‰² */
.call-button, .video-button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: #000000;
  color: #ffffff;
  border: 2px solid #000000;
  font-weight: 500;
}

.call-button:hover, .video-button:hover {
  background: #333333;
  color: #ffffff;
  border-color: #333333;
  transform: translateY(-2px);
}

.communication-stats {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.85rem;
}

.communication-stats p {
  margin: 6px 0;
}

/* æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½®åŒºåŸŸ */
.active-call-controls {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
  border-left: 4px solid var(--accent);
}

.active-call-item {
  margin-bottom: 16px;
}

.active-call-item:last-child {
  margin-bottom: 0;
}

.active-call-slider {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(to right, #ccc, var(--accent));
  border-radius: 3px;
  outline: none;
  margin-top: 8px;
}

.active-call-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.active-call-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.active-call-value {
  font-weight: 600;
  color: var(--accent);
  font-size: 1rem;
}

.active-call-preview {
  background: rgba(138, 127, 141, 0.1);
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.85rem;
  line-height: 1.5;
}

.active-call-preview p {
  margin: 4px 0;
}

/* æ–°å¢ï¼šé¢„è®¾æ¨¡å¼æŒ‰é’® */
.preset-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.preset-btn {
  padding: 8px;
  border: 1px solid var(--accent-gray);
  border-radius: 6px;
  background: white;
  color: var(--text);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.preset-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

.preset-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* äº‘å¯¼å…¥åŒºåŸŸ */
.cloud-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.cloud-item {
  margin-bottom: 16px;
}

.cloud-item:last-child {
  margin-bottom: 0;
}

.cloud-textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
  font-family: monospace;
}

.cloud-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.cloud-info {
  font-size: 0.8rem;
  color: rgba(92, 92, 92, 0.7);
  margin-top: 12px;
}

/* èƒŒæ™¯è®¾ç½®åŒºåŸŸ */
.background-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.background-item {
  margin-bottom: 16px;
}

.background-item:last-child {
  margin-bottom: 0;
}

.background-preview {
  width: 100%;
  height: 150px;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 12px;
  border: 2px dashed rgba(92, 92, 92, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: cover;
  background-position: center;
  position: relative;
}

.background-preview.empty {
  background: rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
}

.background-preview.empty i {
  font-size: 2rem;
  color: rgba(92, 92, 92, 0.3);
}

.background-preview.empty span {
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.5);
}

.background-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 16px;
}

.background-option {
  width: 100%;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.background-option:hover {
  transform: scale(1.02);
}

.background-option.active {
  border-color: var(--accent);
}

.background-option img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-option.color {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  color: white;
  font-weight: 500;
  background: #f5f5f5;
  color: var(--text);
}

.background-option.color span {
  position: relative;
  z-index: 2;
}

.background-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.background-upload-btn {
  flex: 1;
}

/* ä¿®æ”¹ï¼šæ¢å¤é»˜è®¤èƒŒæ™¯æŒ‰é’®æ”¹ä¸ºç°è‰² */
.remove-background-btn {
  background: var(--accent-gray);
  color: white;
  border: none;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
  margin-top: 10px;
}

.remove-background-btn:hover {
  background: var(--accent-gray-light);
}

/* å¡”ç½—ç‰Œè®¾ç½®åŒºåŸŸ */
.tarot-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.tarot-item {
  margin-bottom: 16px;
}

.tarot-item:last-child {
  margin-bottom: 0;
}

.tarot-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 12px;
  background: var(--tarot-bg);
  border-radius: 10px;
  border-left: 4px solid var(--tarot-text);
}

.tarot-switch-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  color: var(--tarot-text);
}

.tarot-switch-label i {
  font-size: 1.2rem;
}

.tarot-count-control {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.tarot-count-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text);
}

.tarot-number-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.tarot-number {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.tarot-number:hover {
  background: rgba(138, 127, 141, 0.2);
}

.tarot-number.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent-light);
}

.tarot-textarea {
  width: 100%;
  height: 200px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
}

.tarot-textarea:focus {
  outline: none;
  border-color: var(--tarot-text);
  background: rgba(255, 255, 255, 0.9);
}

.tarot-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.7);
}

.tarot-status {
  padding: 8px 12px;
  background: var(--tarot-bg);
  border-radius: 8px;
  font-size: 0.85rem;
  color: var(--tarot-text);
  margin-top: 16px;
  border-left: 3px solid var(--tarot-text);
}

/* éšè—çš„æ–‡ä»¶è¾“å…¥ */
.hidden-file-input {
  display: none;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
  width: 5px;
}

::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 8px;
}

::-webkit-scrollbar-thumb {
  background: rgba(92, 92, 92, 0.3);
  border-radius: 8px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(92, 92, 92, 0.5);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .container {
    height: 95vh;
    padding: 10px;
    gap: 10px;
  }
  
  .chat-header {
    padding: 5px 0;
  }
  
  .chat-title-area h1 {
    font-size: 1.4rem;
  }
  
  .settings-panel {
    width: 100%;
    right: -100%;
  }
  
  .user-info {
    width: 65px;
  }
  
  .avatar {
    width: 40px;
    height: 40px;
  }
  
  .status-indicator {
    right: 8px;
    width: 8px;
    height: 8px;
  }
  
  .date-inputs {
    flex-direction: column;
  }
  
  .tab-button {
    min-width: 70px;
    padding: 10px 8px;
    font-size: 0.8rem;
  }
  
  .chat-subtitle {
    font-size: 0.7rem;
  }
  
  .love-days {
    font-size: 0.65rem;
    padding: 2px 6px;
  }
  
  .communication-buttons {
    flex-direction: column;
  }
  
  .input-area-buttons {
    flex-wrap: wrap;
  }
  
  .background-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tarot-number-selector {
    justify-content: center;
  }
  
  .message-actions {
    top: -45px;
  }
  
  .message-action-btn {
    padding: 8px 12px;
    font-size: 0.75rem;
  }
  
  /* ç§»åŠ¨ç«¯è°ƒæ•´è¾“å…¥æ¡†å¸ƒå±€ */
  .message-input {
    min-width: 150px;
  }
  
  .continue-button {
    width: 40px;
    height: 40px;
    font-size: 1.3rem;
  }
  
  .upload-image-button {
    width: 40px;
    height: 40px;
  }
  
  .send-button {
    padding: 12px 16px;
  }
  
  .preset-buttons {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  .chat-title-area h1 {
    font-size: 1.2rem;
  }
  
  .user-info {
    width: 60px;
  }
  
  .avatar {
    width: 36px;
    height: 36px;
  }
  
  .nickname {
    font-size: 0.7rem;
  }
  
  .status-text,
  .mood-percentage {
    font-size: 0.6rem;
  }
  
  .tab-button {
    min-width: 60px;
    font-size: 0.75rem;
    padding: 8px 6px;
  }
  
  .chat-container {
    padding: 12px;
  }
  
  .message {
    font-size: 0.85rem;
    padding: 6px 10px;
  }
  
  .background-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tarot-number {
    width: 32px;
    height: 32px;
    font-size: 0.8rem;
  }
  
  .message-actions {
    top: -50px;
    flex-direction: column;
  }
  
  .message-action-btn {
    padding: 10px 12px;
    width: 100%;
    text-align: center;
  }
  
  /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥è°ƒæ•´è¾“å…¥æ¡†å¸ƒå±€ */
  .input-area-buttons {
    gap: 6px;
  }
  
  .message-input {
    min-width: 120px;
    padding: 10px 14px;
    font-size: 0.85rem;
  }
  
  .continue-button {
    width: 36px;
    height: 36px;
    font-size: 1.2rem;
  }
  
  .upload-image-button {
    width: 36px;
    height: 36px;
  }
  
  .upload-image-button i {
    font-size: 1rem;
  }
  
  .send-button {
    padding: 10px 14px;
    font-size: 0.85rem;
  }
  
  .preset-buttons {
    grid-template-columns: 1fr;
  }
}

/* é®ç½©å±‚ */
.settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(2px);
  z-index: 999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.settings-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* é€šçŸ¥æ ·å¼ */
.notification {
  position: fixed;
  bottom: 15px;
  right: 15px;
  background: var(--accent);
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  animation: fadeInOut 3s ease;
  font-size: 0.85rem;
  max-width: 300px;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(10px); }
}

/* é€šè¯/è§†é¢‘å°çª—å£ */
.call-window, .video-window {
  position: fixed;
  width: 40mm;
  height: 40mm;
  background: var(--bg-panel);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  resize: none;
  cursor: move;
  border: 1px solid rgba(92, 92, 92, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  touch-action: none;
}

.call-window:hover, .video-window:hover {
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
}

.call-window {
  border-top: 4px solid #000000;
}

.video-window {
  border-top: 4px solid #000000;
}

.call-window.active, .video-window.active {
  transform: scale(1.02);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.window-header {
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  touch-action: none;
}

.window-title {
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.window-title i {
  font-size: 1rem;
}

.call-window .window-title {
  color: #000000;
}

.video-window .window-title {
  color: #000000;
}

.window-controls {
  display: flex;
  gap: 6px;
}

.window-btn {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: none;
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  touch-action: manipulation;
}

.window-btn:hover {
  background: rgba(92, 92, 92, 0.2);
}

.window-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 15px;
}

.call-avatar, .video-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 10px;
  border: 2px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.call-avatar {
  border-color: #000000;
}

.video-avatar {
  border-color: #000000;
}

.call-avatar img, .video-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.calling-text {
  font-size: 0.8rem;
  color: var(--text);
  margin-bottom: 10px;
  text-align: center;
}

.in-call-text {
  font-size: 0.75rem;
  color: #333;
  background: rgba(0, 0, 0, 0.05);
  padding: 4px 8px;
  border-radius: 6px;
  margin-bottom: 10px;
  font-weight: 500;
}

.call-timer {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  font-family: monospace;
}

.call-buttons {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.accept-btn, .reject-btn, .end-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-width: 70px;
  touch-action: manipulation;
}

.accept-btn {
  background: var(--online);
  color: white;
}

.accept-btn:hover {
  background: #3d8b40;
}

.reject-btn {
  background: #f44336;
  color: white;
}

.reject-btn:hover {
  background: #d32f2f;
}

.end-btn {
  background: #f44336;
  color: white;
}

.end-btn:hover {
  background: #d32f2f;
}

/* é€šè¯è®°å½•æ¶ˆæ¯æ ·å¼ */
.call-message, .video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

.video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

/* å¡”ç½—ç‰Œæ¶ˆæ¯æ ·å¼ */
.tarot-message {
  background: var(--tarot-bg);
  border-left: 3px solid var(--tarot-text);
  color: var(--tarot-text);
}

/* è®¾ç½®å›¾æ ‡å­—ä½“ */
@font-face {
  font-family: 'Material Icons';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
}

.material-icons {
  font-family: 'Material Icons';
  font-weight: normal;
  font-style: normal;
  font-size: 20px;
  line-height: 1;
  letter-spacing: normal;
  text-transform: none;
  display: inline-block;
  white-space: nowrap;
  word-wrap: normal;
  direction: ltr;
  -webkit-font-feature-settings: 'liga';
  -webkit-font-smoothing: antialiased;
}

/* æ˜µç§°ç¼–è¾‘æ¡† */
.nickname-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--accent);
  color: var(--text);
  font-size: 0.8rem;
  text-align: center;
  width: 100%;
  outline: none;
  padding: 2px 0;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(3px);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  border-radius: 18px;
  padding: 24px;
  width: 90%;
  max-width: 350px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.modal-title {
  margin-top: 0;
  margin-bottom: 16px;
  color: var(--accent);
  font-weight: 400;
  text-align: center;
  font-size: 1.3rem;
}

.avatar-preview {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  overflow: hidden;
  margin: 0 auto 16px;
  border: 2px solid var(--accent);
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.modal-buttons {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.modal-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.primary {
  background: var(--accent-gray);
  color: white;
}

.modal-btn.secondary {
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
}

.modal-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

/* å¼€å…³æ ·å¼ */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--tarot-text);
}

input:checked + .slider:before {
  transform: translateX(24px);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
  .call-window, .video-window {
    width: 60mm;
    height: 60mm;
    max-width: 90vw;
    max-height: 90vw;
  }
  
  .call-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .accept-btn, .reject-btn, .end-btn {
    width: 100%;
    padding: 12px;
  }
}
</style>
</head>
<body>
<!-- èƒŒæ™¯å›¾ç‰‡å®¹å™¨ -->
<div class="background-container" id="backgroundContainer"></div>

<div class="container">
  <!-- è®¾ç½®é®ç½©å±‚ -->
  <div class="settings-overlay" id="settingsOverlay"></div>
  
  <!-- ç”¨æˆ·ä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
      
      <div class="avatar-preview" id="avatarPreview">
        <!-- å¤´åƒé¢„è§ˆ -->
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:6px; color:var(--text); font-size:0.85rem;">æ˜µç§°:</label>
        <input type="text" class="nickname-input" id="modalNicknameInput" maxlength="12" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(92,92,92,0.3); font-size:0.85rem;">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:6px; color:var(--text); font-size:0.85rem;">æ›´æ¢å¤´åƒ:</label>
        <input type="file" id="modalAvatarUpload" class="hidden-file-input" accept="image/*">
        <button class="add-sticker-btn" id="uploadAvatarBtn" style="margin-bottom:0; padding:10px; font-size:0.85rem;">é€‰æ‹©å¤´åƒå›¾ç‰‡</button>
      </div>
      
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelEditBtn">å–æ¶ˆ</button>
        <button class="modal-btn primary" id="saveUserInfoBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- èŠå¤©å¤´éƒ¨ -->
  <div class="chat-header">
    <!-- å·¦ä¾§ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯¹æ–¹ï¼‰ -->
    <div class="user-info" id="otherUserInfo">
      <div class="avatar" id="otherAvatar">
        <!-- ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— é»˜è®¤å›¾ç‰‡ -->
      </div>
      <div class="status-indicator" id="otherStatusIndicator"></div>
      <div class="status-text" id="otherStatusText">åœ¨DR</div>
      <div class="mood-percentage" id="otherMoodPercentage">
        <span style="font-size:0.6rem; margin-right:2px;">å¿ƒæƒ…æŒ‡æ•°:</span>
        <span id="otherMoodValue">85%</span>
      </div>
      <div class="nickname" id="otherNickname">å¯¹æ–¹</div>
    </div>
    
    <!-- ä¸­é—´æ ‡é¢˜ -->
    <div class="chat-title-area">
      <h1 id="appTitle">æ¢¦è§’çˆ±äºº</h1>
      <div class="love-days" id="loveDays">
        <i class="material-icons">favorite</i>
        <span id="loveDaysCount">æ‹çˆ±ç¬¬ 0 å¤©</span>
      </div>
      <div class="chat-subtitle" id="appSubtitle">ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´</div>
    </div>
    
    <!-- å³ä¾§ç”¨æˆ·ä¿¡æ¯ï¼ˆè‡ªå·±ï¼‰å’Œè®¾ç½®æŒ‰é’® -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="user-info" id="selfUserInfo">
        <div class="avatar" id="selfAvatar">
          <!-- ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— é»˜è®¤å›¾ç‰‡ -->
        </div>
        <div class="status-text" id="selfStatusText">åœ¨çº¿</div>
        <div class="nickname" id="selfNickname">æˆ‘</div>
      </div>
      
      <div class="settings-toggle" id="settingsToggle">
        <i class="material-icons">settings</i>
      </div>
    </div>
  </div>
  
  <!-- èŠå¤©åŒºåŸŸ -->
  <section class="chat-section">
    <div class="chat-container">
      <div class="messages-area" id="messagesArea">
        <!-- å¯¹æ–¹æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
        <div class="typing-indicator" id="typingIndicator">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <span style="font-size:0.75rem; margin-left:4px;">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</span>
        </div>
        
        <!-- åˆå§‹æ¶ˆæ¯å°†ä»æœ¬åœ°å­˜å‚¨åŠ è½½ -->
      </div>
      
      <div class="input-area">
        <div class="input-area-buttons">
          <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="200">
          <div class="upload-image-button" id="uploadImageButton" title="å‘é€å›¾ç‰‡">
            <i class="material-icons">image</i>
          </div>
          <input type="file" id="imageUpload" class="hidden-file-input" accept="image/*">
          <button class="continue-button" id="continueButton">...</button>
          <button class="send-button" id="sendButton">å‘é€</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- è®¾ç½®é¢æ¿ -->
<div class="settings-panel" id="settingsPanel">
  <div class="settings-header">
    <h2>è®¾ç½®</h2>
    <button class="close-settings" id="closeSettings">
      <i class="material-icons">close</i>
    </button>
  </div>
  
  <div class="settings-tabs">
    <button class="tab-button active" data-tab="stickers">è¡¨æƒ…åŒ…åº“</button>
    <button class="tab-button" data-tab="phrases">å›å¤è¯æ¡</button>
    <button class="tab-button" data-tab="tarot">å¡”ç½—ç‰Œå­—å¡æŠ½å–ğŸ”®</button>
    <button class="tab-button" data-tab="ratio">å‘é€è®¾ç½®</button>
    <button class="tab-button" data-tab="appearance">å¤–è§‚è®¾ç½®</button>
    <button class="tab-button" data-tab="background">èƒŒæ™¯è®¾ç½®</button>
    <button class="tab-button" data-tab="communication">é€šè¯è§†é¢‘</button>
    <button class="tab-button" data-tab="cloud">äº‘å¯¼å…¥</button>
    <button class="tab-button" data-tab="export">å¯¼å‡ºè®°å½•</button>
  </div>
  
  <div class="settings-content">
    <!-- è¡¨æƒ…åŒ…åº“æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="stickersTab">
      <div class="sticker-library">
        <h3>è¡¨æƒ…åŒ…åº“ç®¡ç†</h3>
        <p>æ·»åŠ å›¾ç‰‡åï¼Œå¯¹æ–¹å¯ä»¥éšæœºå‘é€è¿™äº›è¡¨æƒ…åŒ…ä½œä¸ºå›å¤</p>
        
        <div class="sticker-preview" id="stickerPreview">
          <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          <div class="sticker-item" id="addStickerPlaceholder">
            <div class="sticker-placeholder">+</div>
          </div>
        </div>
        
        <input type="file" id="stickerUpload" class="hidden-file-input" accept="image/*" multiple>
        <button class="add-sticker-btn" id="addStickerBtn">ä»ç›¸å†Œæ·»åŠ è¡¨æƒ…åŒ…</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šç‚¹å‡»è¡¨æƒ…åŒ…å³ä¸Šè§’çš„Ã—å¯ä»¥åˆ é™¤ã€‚å·²æ·»åŠ  <span id="stickerCount">0</span> ä¸ªè¡¨æƒ…åŒ…
        </p>
      </div>
    </div>
    
    <!-- å›å¤è¯æ¡æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="phrasesTab">
      <div class="phrases-library">
        <h3>å›å¤è¯æ¡ç®¡ç†</h3>
        <p style="margin-bottom: 8px;">å¯¹æ–¹å°†ä»è¿™äº›è¯æ¡ä¸­éšæœºæŠ½å–ä½œä¸ºå›å¤ã€‚æ¯è¡Œä¸€ä¸ªè¯æ¡ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†è¡Œã€‚</p>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 16px;">æç¤ºï¼šç‚¹å‡»ä»»æ„æ¶ˆæ¯å¯ä»¥å¼•ç”¨oråˆ é™¤oræ’¤å›</p>
        
        <textarea class="phrases-textarea" id="phrasesTextarea" placeholder="è¯·è¾“å…¥å›å¤è¯æ¡ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;å¥½çš„ï¼Œæ˜ç™½äº†&#10;è¿™å¾ˆæœ‰è¶£&#10;ç»§ç»­èŠå§&#10;è®©æˆ‘æƒ³æƒ³"></textarea>
        
        <div class="phrases-info">
          <span>å½“å‰è¯æ¡æ•°: <span id="phraseCount">0</span></span>
          <span>éšæœºæ··åˆè¡¨æƒ…åŒ…å’Œå­—å¡å‘é€</span>
        </div>
        
        <button class="save-phrases-btn" id="savePhrasesBtn">ä¿å­˜è¯æ¡</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šä¿å­˜åï¼Œå¯¹æ–¹å°†ä»è¿™äº›è¯æ¡å’Œè¡¨æƒ…åŒ…ä¸­éšæœºé€‰æ‹©ï¼Œéšæœºæ··åˆå‘é€<br>
          ï¼ˆå¡”ç½—ç‰Œæ¨¡å¼å¼€å¯æ—¶ï¼Œå°†ä¼˜å…ˆä½¿ç”¨å¡”ç½—ç‰Œå­—å¡ï¼‰
        </p>
      </div>
    </div>
    
    <!-- å¡”ç½—ç‰Œå­—å¡æŠ½å–æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="tarotTab">
      <div class="tarot-library">
        <h3>å¡”ç½—ç‰Œå­—å¡æŠ½å–ğŸ”®</h3>
        <p>å¼€å¯å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼ï¼Œå¯¹æ–¹å°†åªæŠ½å–å¡”ç½—ç‰Œå­—å¡è¿›è¡Œå›å¤</p>
        
        <div class="tarot-controls">
          <div class="tarot-switch">
            <div class="tarot-switch-label">
              <i class="material-icons">auto_awesome</i>
              <span>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="tarotModeToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="tarot-item">
            <div class="tarot-count-control">
              <div class="tarot-count-label">æ¯æ¬¡æŠ½å–æ•°é‡:</div>
              <div id="tarotCountValue">1</div>
            </div>
            
            <div class="tarot-number-selector" id="tarotNumberSelector">
              <!-- æ•°å­—1-15å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <div class="tarot-item">
            <label class="communication-label">å¡”ç½—ç‰Œå­—å¡åº“:</label>
            <textarea class="tarot-textarea" id="tarotTextarea" placeholder="è¯·è¾“å…¥å¡”ç½—ç‰Œå­—å¡ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;æ„šäºº æ­£ä½&#10;é­”æœ¯å¸ˆ é€†ä½&#10;å¥³ç¥­å¸ æ­£ä½&#10;ä¸–ç•Œ é€†ä½"></textarea>
            
            <div class="tarot-info">
              <span>å½“å‰å¡”ç½—ç‰Œå­—å¡æ•°: <span id="tarotPhraseCount">0</span></span>
              <span>æ¯è¡Œä¸€ä¸ªå­—å¡</span>
            </div>
          </div>
          
          <button class="save-tarot-btn" id="saveTarotBtn">ä¿å­˜å¡”ç½—ç‰Œè®¾ç½®</button>
          
          <div class="tarot-status" id="tarotStatus">
            å¡”ç½—ç‰Œæ¨¡å¼å·²å…³é—­ï¼Œå¯¹æ–¹ä½¿ç”¨æ™®é€šè¯æ¡å’Œè¡¨æƒ…åŒ…å›å¤
          </div>
          
          <!-- å¡”ç½—ç‰Œæ“ä½œæŒ‰é’® -->
          <div style="display: flex; gap: 10px; margin-top: 16px;">
            <button class="cloud-btn" id="loadDefaultTarotBtn" style="flex: 1; padding: 10px;">åŠ è½½é»˜è®¤78å¼ å¡”ç½—ç‰Œ</button>
            <button class="cloud-btn" id="clearTarotBtn" style="flex: 1; padding: 10px; background: #888;">æ¸…ç©ºå¡”ç½—ç‰Œåº“</button>
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border-left: 3px solid var(--tarot-text);">
            <p style="margin: 0 0 8px 0; font-size: 0.85rem; font-weight: 500; color: var(--tarot-text);">æŠ½å–è§„åˆ™è¯´æ˜ï¼š</p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ æ™ºèƒ½è¯†åˆ«ç‰Œåï¼šæ”¯æŒ"æ„šäºº æ­£ä½"ã€"æ­£ä½Â·é­”æœ¯å¸ˆ"ã€"é€†ä½-å¥³ç¥­å¸"ç­‰å¤šç§æ ¼å¼
            </p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ åŒç‰Œæ­£é€†ä½ä¸é‡å¤ï¼šæŠ½åˆ°"æ„šäºº æ­£ä½"åï¼Œä¸ä¼šå†æŠ½"æ„šäºº é€†ä½"
            </p>
          </div>
        </div>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¼€å¯å¡”ç½—ç‰Œæ¨¡å¼åï¼Œå¯¹æ–¹å›å¤å°†åªä»å¡”ç½—ç‰Œå­—å¡åº“ä¸­æŠ½å–<br>
          å¯ä»¥è®¾ç½®æ¯æ¬¡æŠ½å–1-15å¼ å¡”ç½—ç‰Œå­—å¡<br>
          <strong>æ™ºèƒ½è§„åˆ™ï¼šåŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–</strong>
        </p>
      </div>
    </div>
    
    <!-- å‘é€è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="ratioTab">
      <div class="ratio-library">
        <h3>å‘é€è®¾ç½®</h3>
        <p>è°ƒæ•´å¯¹æ–¹å›å¤æ—¶è¡¨æƒ…åŒ…å’Œå­—å¡çš„å‘é€æ¯”ä¾‹</p>
        
        <div class="ratio-controls">
          <div class="ratio-item">
            <div class="ratio-label">
              <span>è¡¨æƒ…åŒ…å‘é€æ¯”ä¾‹</span>
              <span class="ratio-value" id="stickerRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="stickerRatioSlider">
          </div>
          
          <div class="ratio-item">
            <div class="ratio-label">
              <span>å­—å¡å‘é€æ¯”ä¾‹</span>
              <span class="ratio-value" id="phraseRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="phraseRatioSlider">
          </div>
          
          <div class="max-count-control">
            <div class="max-count-label">æœ€å¤§å‘é€æ•°é‡:</div>
            <select class="max-count-select" id="maxMessageCount">
              <option value="1">1æ¡</option>
              <option value="2">2æ¡</option>
              <option value="3" selected>3æ¡</option>
              <option value="4">4æ¡</option>
              <option value="5">5æ¡</option>
            </select>
          </div>
          
          <div class="auto-send-controls">
            <div class="auto-send-label">ä¸»åŠ¨å‘é€é¢‘ç‡:</div>
            <select class="auto-send-select" id="autoSendFrequency">
              <option value="0">ä¸ä¸»åŠ¨å‘é€</option>
              <option value="300000">5åˆ†é’Ÿ</option>
              <option value="600000" selected>10åˆ†é’Ÿ</option>
              <option value="1200000">20åˆ†é’Ÿ</option>
              <option value="1800000">30åˆ†é’Ÿ</option>
              <option value="3600000">1å°æ—¶</option>
            </select>
          </div>
        </div>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¯¹æ–¹å›å¤æ—¶ä¼šæ ¹æ®æ­¤æ¯”ä¾‹éšæœºæ··åˆå‘é€è¡¨æƒ…åŒ…å’Œå­—å¡<br>
          å¯¹æ–¹ä¹Ÿä¼šæ ¹æ®è®¾ç½®çš„é¢‘ç‡ä¸»åŠ¨å‘é€æ¶ˆæ¯<br>
          ï¼ˆå¡”ç½—ç‰Œæ¨¡å¼å¼€å¯æ—¶ï¼Œå°†å¿½ç•¥æ­¤æ¯”ä¾‹è®¾ç½®ï¼ŒåªæŠ½å–å¡”ç½—ç‰Œå­—å¡ï¼‰
        </p>
      </div>
    </div>
    
    <!-- å¤–è§‚è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="appearanceTab">
      <div class="appearance-library">
        <h3>å¤–è§‚è®¾ç½®</h3>
        <p>è‡ªå®šä¹‰èŠå¤©ç•Œé¢çš„å¤–è§‚å’Œæ˜¾ç¤ºä¿¡æ¯</p>
        
        <div class="appearance-controls">
          <div class="appearance-item">
            <label class="appearance-label">åº”ç”¨æ ‡é¢˜:</label>
            <input type="text" class="appearance-input" id="appTitleInput" value="æ¢¦è§’çˆ±äºº" maxlength="20">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">åº”ç”¨å‰¯æ ‡é¢˜:</label>
            <input type="text" class="appearance-input" id="appSubtitleInput" value="ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´" maxlength="50">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">æ‹çˆ±èµ·å§‹æ—¥æœŸ:</label>
            <div class="date-inputs">
              <input type="number" class="date-input" id="loveYear" placeholder="å¹´" min="2000" max="2100" value="2024">
              <input type="number" class="date-input" id="loveMonth" placeholder="æœˆ" min="1" max="12" value="1">
              <input type="number" class="date-input" id="loveDay" placeholder="æ—¥" min="1" max="31" value="1">
            </div>
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">å¯¹æ–¹å¿ƒæƒ…å˜åŒ–é¢‘ç‡:</label>
            <select class="appearance-input" id="moodChangeFrequency">
              <option value="60000">1åˆ†é’Ÿ</option>
              <option value="300000">5åˆ†é’Ÿ</option>
              <option value="600000" selected>10åˆ†é’Ÿ</option>
              <option value="1200000">20åˆ†é’Ÿ</option>
              <option value="1800000">30åˆ†é’Ÿ</option>
            </select>
          </div>
        </div>
        
        <button class="save-phrases-btn" id="saveAppearanceBtn">ä¿å­˜å¤–è§‚è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šä¿å­˜åï¼Œåº”ç”¨æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œæ‹çˆ±å¤©æ•°å°†ç«‹å³æ›´æ–°
        </p>
      </div>
    </div>
    
    <!-- èƒŒæ™¯è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="backgroundTab">
      <div class="background-library">
        <h3>èƒŒæ™¯è®¾ç½®</h3>
        <p>è‡ªå®šä¹‰èŠå¤©èƒŒæ™¯ï¼Œå¯ä»¥é€‰æ‹©é¢„è®¾èƒŒæ™¯æˆ–ä¸Šä¼ è‡ªå·±çš„å›¾ç‰‡</p>
        
        <div class="background-controls">
          <div class="background-item">
            <label class="communication-label">å½“å‰èƒŒæ™¯é¢„è§ˆ:</label>
            <div class="background-preview" id="backgroundPreview">
              <div class="empty">
                <i class="material-icons">wallpaper</i>
                <span>é»˜è®¤èƒŒæ™¯</span>
              </div>
            </div>
          </div>
          
          <div class="background-item">
            <label class="communication-label">ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡:</label>
            <div class="background-options">
              <div class="background-option color" id="uploadBackgroundOption">
                <span>ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</span>
              </div>
            </div>
            <input type="file" id="backgroundUpload" class="hidden-file-input" accept="image/*">
          </div>
          
          <div class="background-item">
            <label class="communication-label">èƒŒæ™¯é€æ˜åº¦:</label>
            <input type="range" min="0" max="100" value="100" class="ratio-slider" id="backgroundOpacitySlider">
            <div style="display:flex; justify-content:space-between; margin-top:8px;">
              <span style="font-size:0.8rem;">é€æ˜</span>
              <span style="font-size:0.8rem;" id="backgroundOpacityValue">100%</span>
              <span style="font-size:0.8rem;">ä¸é€æ˜</span>
            </div>
          </div>
          
          <button class="remove-background-btn" id="removeBackgroundBtn">æ¢å¤é»˜è®¤èƒŒæ™¯</button>
        </div>
        
        <button class="save-background-btn" id="saveBackgroundBtn">ä¿å­˜èƒŒæ™¯è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šä¸Šä¼ çš„å›¾ç‰‡ä¼šä¿å­˜åœ¨æœ¬åœ°ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±
        </p>
      </div>
    </div>
    
    <!-- é€šä¿¡è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="communicationTab">
      <div class="communication-library">
        <h3>é€šè¯ä¸è§†é¢‘</h3>
        <p>æ¨¡æ‹Ÿé€šè¯å’Œè§†é¢‘åŠŸèƒ½ï¼Œå¯¹æ–¹å¯ä»¥ä¸»åŠ¨é‚€è¯·æˆ–å“åº”ç”¨æˆ·çš„é‚€è¯·</p>
        
        <div class="communication-controls">
          <div class="communication-item">
            <div class="communication-label">ä¸»åŠ¨å‘¼å«å¯¹æ–¹</div>
            <div class="communication-buttons">
              <button class="call-button" id="startCallButton">
                <i class="material-icons">call</i>
                è¯­éŸ³é€šè¯
              </button>
              <button class="video-button" id="startVideoButton">
                <i class="material-icons">videocam</i>
                è§†é¢‘é€šè¯
              </button>
            </div>
          </div>
          
          <div class="communication-item">
            <div class="communication-label">é€šè¯è®¾ç½®</div>
            <div style="margin-top: 10px;">
              <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; margin-bottom:8px;">
                <input type="checkbox" id="autoAcceptCalls" checked>
                <span>è‡ªåŠ¨æ¥å¬å¯¹æ–¹æ¥ç”µ</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem;">
                <input type="checkbox" id="autoAcceptVideos" checked>
                <span>è‡ªåŠ¨æ¥å¬å¯¹æ–¹è§†é¢‘é‚€è¯·</span>
              </label>
            </div>
          </div>
          
          <!-- ä¸»åŠ¨å‘¼å«è®¾ç½® -->
          <div class="active-call-controls">
            <div class="communication-label">å¯¹æ–¹ä¸»åŠ¨å‘¼å«è®¾ç½®</div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>æ€»ä½“å‘¼å«é¢‘ç‡</span>
                <span class="active-call-value" id="overallFrequencyValue">30%</span>
              </div>
              <input type="range" min="0" max="100" value="30" class="active-call-slider" id="overallFrequencySlider">
              <div style="display:flex; justify-content:space-between; margin-top:4px;">
                <span style="font-size:0.75rem; color:#888;">å…³é—­</span>
                <span style="font-size:0.75rem; color:#888;">æœ€é«˜</span>
              </div>
            </div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>å‘¼å«ç±»å‹åå¥½</span>
                <span class="active-call-value" id="callPreferenceValue">ç”µè¯ 50% / è§†é¢‘ 50%</span>
              </div>
              <input type="range" min="0" max="100" value="50" class="active-call-slider" id="callPreferenceSlider">
              <div style="display:flex; justify-content:space-between; margin-top:4px;">
                <span style="font-size:0.75rem; color:#888;">çº¯ç”µè¯</span>
                <span style="font-size:0.75rem; color:#888;">çº¯è§†é¢‘</span>
              </div>
            </div>
            
            <!-- é¢„è®¾æ¨¡å¼ -->
            <div class="active-call-item">
              <div class="ratio-label">
                <span>é¢„è®¾æ¨¡å¼</span>
              </div>
              <div class="preset-buttons">
                <button class="preset-btn" data-preset="quiet">å®‰é™æ¨¡å¼</button>
                <button class="preset-btn" data-preset="daily">æ—¥å¸¸æ¨¡å¼</button>
                <button class="preset-btn" data-preset="intimate">äº²å¯†æ¨¡å¼</button>
                <button class="preset-btn active" data-preset="custom">è‡ªå®šä¹‰</button>
              </div>
            </div>
            
            <!-- è¯¦ç»†é¢„è§ˆ -->
            <div class="active-call-preview" id="activeCallPreview">
              <p><strong>å½“å‰è®¾ç½®é¢„è§ˆï¼š</strong></p>
              <p>â€¢ æ€»ä½“é¢‘ç‡ï¼š<span id="previewFrequency">ä¸­ç­‰ (30%)</span></p>
              <p>â€¢ å‘¼å«ç±»å‹ï¼š<span id="previewType">ç”µè¯ 50% / è§†é¢‘ 50%</span></p>
              <p>â€¢ é¢„è®¡æ¯å¤©ï¼š<span id="previewDaily">2-4æ¬¡å‘¼å«</span></p>
              <p>â€¢ ä¸‹æ¬¡å‘¼å«ï¼š<span id="previewNext">15-30åˆ†é’Ÿå†…</span></p>
            </div>
          </div>
          
          <div class="communication-stats">
            <p style="margin:0 0 8px 0; font-weight:500;">é€šè¯ç»Ÿè®¡</p>
            <p style="margin:6px 0;">ä»Šæ—¥é€šè¯: <span id="todayCalls">0</span> æ¬¡</p>
            <p style="margin:6px 0;">æ€»é€šè¯æ—¶é•¿: <span id="totalCallTime">0</span> åˆ†é’Ÿ</p>
            <p style="margin:6px 0;">ä»Šæ—¥è§†é¢‘: <span id="todayVideos">0</span> æ¬¡</p>
            <p style="margin:6px 0;">æ€»è§†é¢‘æ—¶é•¿: <span id="totalVideoTime">0</span> åˆ†é’Ÿ</p>
            <p style="margin:6px 0; font-size:0.8rem; color:#666;">å¯¹æ–¹ä»Šæ—¥ä¸»åŠ¨å‘¼å«: <span id="todayIncomingCalls">0</span> æ¬¡</p>
          </div>
        </div>
        
        <button class="communication-btn" id="saveCommunicationBtn">ä¿å­˜é€šè¯è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šé€šè¯/è§†é¢‘å°çª—å£å¯ä»¥éšæ„æ‹–åŠ¨ä½ç½®ï¼ˆæ”¯æŒæ‰‹æœºè§¦æ‘¸æ‹–åŠ¨ï¼‰<br>
          å¯¹æ–¹ä¼šæ ¹æ®æ‚¨çš„è®¾ç½®ä¸»åŠ¨å‘èµ·é€šè¯æˆ–è§†é¢‘é‚€è¯·
        </p>
      </div>
    </div>
    
    <!-- äº‘å¯¼å…¥æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="cloudTab">
      <div class="cloud-library">
        <h3>äº‘æ•°æ®å¯¼å…¥</h3>
        <p>å¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„èŠå¤©è®°å½•æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰</p>
        
        <div class="cloud-controls">
          <div class="cloud-item">
            <label class="communication-label">å¯¼å…¥JSONæ•°æ®:</label>
            <textarea class="cloud-textarea" id="cloudImportTextarea" placeholder="è¯·ç²˜è´´ä¹‹å‰å¯¼å‡ºçš„JSONæ•°æ®..."></textarea>
            <div style="display:flex; gap:10px;">
              <button class="cloud-btn" id="importCloudBtn">å¯¼å…¥æ•°æ®</button>
              <button class="cloud-btn" style="background:#888;" id="clearCloudBtn">æ¸…ç©º</button>
            </div>
          </div>
          
          <div class="cloud-item">
            <div class="communication-label">ä»æ–‡ä»¶å¯¼å…¥:</div>
            <input type="file" id="cloudFileUpload" class="hidden-file-input" accept=".json,.txt">
            <button class="cloud-btn" id="importFileBtn">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
          </div>
          
          <div class="cloud-info">
            <p>å¯¼å…¥è¯´æ˜ï¼š</p>
            <p>1. åªèƒ½å¯¼å…¥ä¹‹å‰ä»æ­¤åº”ç”¨å¯¼å‡ºçš„JSONæ ¼å¼æ•°æ®</p>
            <p>2. å¯¼å…¥ä¼šè¦†ç›–å½“å‰çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®</p>
            <p>3. å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®å¤‡ä»½</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¯¼å‡ºè®°å½•æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="exportTab">
      <div class="export-library">
        <h3>èŠå¤©è®°å½•å¯¼å‡º</h3>
        <p>å¯¼å‡ºèŠå¤©è®°å½•ï¼Œæ”¯æŒå¤šç§æ ¼å¼</p>
        
        <div class="export-controls">
          <div class="export-options">
            <div class="export-option">
              <input type="checkbox" id="exportMessages" checked>
              <label for="exportMessages">å¯¼å‡ºèŠå¤©æ¶ˆæ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportSettings" checked>
              <label for="exportSettings">å¯¼å‡ºè®¾ç½®ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportStickers" checked>
              <label for="exportStickers">å¯¼å‡ºè¡¨æƒ…åŒ…ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportPhrases" checked>
              <label for="exportPhrases">å¯¼å‡ºè¯æ¡ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportTarot" checked>
              <label for="exportTarot">å¯¼å‡ºå¡”ç½—ç‰Œè®¾ç½®</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportBackground" checked>
              <label for="exportBackground">å¯¼å‡ºèƒŒæ™¯è®¾ç½®</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportCommunication" checked>
              <label for="exportCommunication">å¯¼å‡ºé€šè¯è®°å½•</label>
            </div>
          </div>
          
          <div class="export-formats">
            <button class="format-btn" id="exportTxtBtn">å¯¼å‡ºä¸ºTXT</button>
            <button class="format-btn" id="exportJsonBtn">å¯¼å‡ºä¸ºJSON</button>
            <button class="format-btn" id="exportHtmlBtn">å¯¼å‡ºä¸ºHTML</button>
          </div>
        </div>
        
        <button class="export-btn" id="exportAllBtn">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¯¼å‡ºæ•°æ®åŒ…å«æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®<br>
          å¯ä»¥åœ¨å…¶ä»–è®¾å¤‡æˆ–æµè§ˆå™¨ä¸­å¯¼å…¥ä½¿ç”¨<br>
          æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œå…³é—­é¡µé¢ä¹Ÿä¸ä¼šä¸¢å¤±
        </p>
      </div>
    </div>
  </div>
</div>

<!-- é€šè¯/è§†é¢‘å°çª—å£ä¼šåŠ¨æ€åˆ›å»º -->

<script>
// ========================
// ç¬¬ä¸€éƒ¨åˆ†ï¼šä»ç¬¬ä¸€ä¸ªä»£ç æ–‡ä»¶ç§»æ¤çš„å¥å£®å­˜å‚¨é€»è¾‘
// ========================

/**
 * æ•°æ®å­˜å‚¨ç®¡ç†ç±» - å®Œå…¨ç§»æ¤è‡ªç¬¬ä¸€ä¸ªä»£ç æ–‡ä»¶
 * ç‰¹ç‚¹ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†ã€å®¹é‡ç®¡ç†ã€æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
 */
class ChatDataManager {
    constructor() {
        // å­˜å‚¨é”®åå®šä¹‰
        this.SELF_INFO_KEY = 'seven_and_wish_self_info';
        this.OTHER_INFO_KEY = 'seven_and_wish_other_info';
        this.MESSAGES_KEY = 'seven_and_wish_messages';
        this.PHRASES_KEY = 'seven_and_wish_phrases';
        this.STICKERS_KEY = 'seven_and_wish_stickers';
        this.SEND_SETTINGS_KEY = 'seven_and_wish_send_settings';
        this.APPEARANCE_KEY = 'seven_and_wish_appearance';
        this.BACKGROUND_KEY = 'seven_and_wish_background';
        this.TAROT_KEY = 'seven_and_wish_tarot_settings';
        this.COMMUNICATION_KEY = 'seven_and_wish_communication';
        this.DRAWN_CARDS_KEY = 'seven_and_wish_drawn_cards';
        this.LOVE_DAYS_KEY = 'seven_and_wish_love_days';
        this.READ_NO_REPLY_KEY = 'seven_and_wish_read_no_reply';
        this.TODAY_DATE_KEY = 'seven_and_wish_today_date';
        
        // ç‰ˆæœ¬æ§åˆ¶
        this.DATA_VERSION_KEY = 'seven_and_wish_data_version';
        this.DATA_VERSION = '2.0'; // ç¬¬äºŒä¸ªæ–‡ä»¶çš„ç‰ˆæœ¬
        
        // æœ€å¤§æ¶ˆæ¯æ•°é‡é™åˆ¶ï¼ˆé˜²æ­¢æ•°æ®è¿‡å¤§ï¼‰
        this.MAX_MESSAGES = 500;
        
        // åˆå§‹åŒ–æ•°æ®
        this.initData();
    }
    
    /**
     * åˆå§‹åŒ–æ•°æ® - åªåœ¨å®Œå…¨æ²¡æœ‰æ•°æ®æ—¶åˆ›å»ºé»˜è®¤æ•°æ®
     * ä¸ä¼šè¦†ç›–å·²æœ‰æ•°æ®
     */
    initData() {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–é»˜è®¤æ•°æ®
        const hasAnyData = localStorage.getItem(this.SELF_INFO_KEY) !== null ||
                          localStorage.getItem(this.OTHER_INFO_KEY) !== null ||
                          localStorage.getItem(this.MESSAGES_KEY) !== null;
        
        if (!hasAnyData) {
            console.log('é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºé»˜è®¤æ•°æ®');
            this.createDefaultData();
        }
        
        // ç¡®ä¿ç‰ˆæœ¬ä¿¡æ¯å­˜åœ¨
        if (!localStorage.getItem(this.DATA_VERSION_KEY)) {
            localStorage.setItem(this.DATA_VERSION_KEY, this.DATA_VERSION);
        }
    }
    
    /**
     * åˆ›å»ºé»˜è®¤æ•°æ® - åªåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è°ƒç”¨
     */
    createDefaultData() {
        // é»˜è®¤è‡ªå·±ä¿¡æ¯
        this.setStoredData(this.SELF_INFO_KEY, {
            nickname: 'æˆ‘',
            avatar: null,
            status: 'åœ¨çº¿'
        });
        
        // é»˜è®¤å¯¹æ–¹ä¿¡æ¯
        this.setStoredData(this.OTHER_INFO_KEY, {
            nickname: 'å¯¹æ–¹',
            avatar: null,
            status: 'åœ¨DR',
            mood: 85
        });
        
        // é»˜è®¤å‘é€è®¾ç½®
        this.setStoredData(this.SEND_SETTINGS_KEY, {
            stickerRatio: 50,
            phraseRatio: 50,
            maxMessageCount: 3,
            autoSendFrequency: 600000
        });
        
        // é»˜è®¤å¤–è§‚è®¾ç½®
        this.setStoredData(this.APPEARANCE_KEY, {
            appTitle: 'æ¢¦è§’çˆ±äºº',
            appSubtitle: 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´',
            loveStartDate: new Date(2024, 0, 1).toISOString(),
            moodChangeFrequency: 600000
        });
        
        // é»˜è®¤èƒŒæ™¯è®¾ç½®
        this.setStoredData(this.BACKGROUND_KEY, {
            backgroundImage: null,
            opacity: 100
        });
        
        // é»˜è®¤å¡”ç½—ç‰Œè®¾ç½®
        this.setStoredData(this.TAROT_KEY, {
            enabled: false,
            drawCount: 1,
            customPhrases: []
        });
        
        // é»˜è®¤é€šä¿¡è®¾ç½®
        this.setStoredData(this.COMMUNICATION_KEY, {
            autoAcceptCalls: true,
            autoAcceptVideos: true,
            todayCalls: 0,
            todayVideos: 0,
            totalCallTime: 0,
            totalVideoTime: 0,
            todayIncomingCalls: 0,
            activeCallSettings: {
                enabled: true,
                overallFrequency: 30,
                callPreference: 50,
                presetMode: 'custom',
                minInterval: 15,
                maxInterval: 45,
                respectBusyStatus: true,
                timeSensitivity: true,
                adaptToActivity: true
            }
        });
        
        // é»˜è®¤å›å¤è¯æ¡
        this.setStoredData(this.PHRASES_KEY, [
            "å¥½çš„ï¼Œæ˜ç™½äº†",
            "è¿™å¾ˆæœ‰è¶£",
            "ç»§ç»­èŠå§",
            "è®©æˆ‘æƒ³æƒ³",
            "å¾ˆæœ‰æ„æ€çš„è§‚ç‚¹",
            "æˆ‘ä¸å¤ªç¡®å®š",
            "å¯ä»¥è¯¦ç»†è¯´è¯´å—",
            "æˆ‘åŒæ„",
            "è¿™æ˜¯ä¸ªå¥½é—®é¢˜",
            "è°¢è°¢åˆ†äº«"
        ]);
        
        // é»˜è®¤æ¶ˆæ¯ï¼ˆåªæœ‰ä¸€æ¡æ¬¢è¿æ¶ˆæ¯ï¼‰
        this.setStoredData(this.MESSAGES_KEY, [{
            id: Date.now(),
            text: "ä½ å¥½ï¼æ¬¢è¿ä½¿ç”¨ç§å¯†èŠå¤©ã€‚ç‚¹å‡»å³ä¸Šè§’çš„é½¿è½®å›¾æ ‡å¯ä»¥ç®¡ç†è¡¨æƒ…åŒ…å’Œå›å¤è¯æ¡ã€‚",
            sender: "other",
            time: this.getFormattedTime(Date.now()),
            read: true
        }]);
        
        // ç©ºçš„è¡¨æƒ…åŒ…
        this.setStoredData(this.STICKERS_KEY, []);
        
        // å·²æŠ½å–å¡”ç½—ç‰Œè®°å½•
        this.setStoredData(this.DRAWN_CARDS_KEY, []);
        
        // æ‹çˆ±å¤©æ•°
        this.setStoredData(this.LOVE_DAYS_KEY, 1);
        
        // å·²è¯»ä¸å›è®°å½•
        this.setStoredData(this.READ_NO_REPLY_KEY, []);
        
        // ä»Šæ—¥æ—¥æœŸ
        this.setStoredData(this.TODAY_DATE_KEY, new Date().toDateString());
        
        // ä¿å­˜ç‰ˆæœ¬
        localStorage.setItem(this.DATA_VERSION_KEY, this.DATA_VERSION);
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
     */
    generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    /**
     * è·å–æ ¼å¼åŒ–æ—¶é—´
     */
    getFormattedTime(timestamp) {
        const date = new Date(timestamp);
        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }
    
    /**
     * å®‰å…¨åœ°ä»localStorageè¯»å–æ•°æ®
     */
    getStoredData(key) {
        try {
            const data = localStorage.getItem(key);
            if (!data) return null;
            
            // å°è¯•è§£æJSON
            try {
                return JSON.parse(data);
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥è¿”å›å­—ç¬¦ä¸²
                return data;
            }
        } catch (e) {
            console.error(`è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥ [${key}]:`, e);
            return null;
        }
    }
    
    /**
     * å®‰å…¨åœ°ä¿å­˜æ•°æ®åˆ°localStorage
     * åŒ…å«å®¹é‡æ£€æŸ¥å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶
     */
    setStoredData(key, data) {
        try {
            // ä¼°ç®—æ•°æ®å¤§å°ï¼ˆç²—ç•¥ï¼‰
            const dataStr = typeof data === 'object' ? JSON.stringify(data) : String(data);
            
            // å¦‚æœæ•°æ®è¿‡å¤§ï¼ˆè¶…è¿‡4.5MBï¼‰ï¼Œå°è¯•æ¸…ç†æˆ–æ‹’ç»
            if (dataStr.length > 4.5 * 1024 * 1024) {
                console.warn(`æ•°æ®è¿‡å¤§ (${(dataStr.length/1024/1024).toFixed(2)}MB)ï¼Œå°è¯•å‹ç¼©...`);
                
                // å¦‚æœæ˜¯èƒŒæ™¯å›¾ç‰‡æˆ–å¤´åƒç­‰base64æ•°æ®ï¼Œå¯èƒ½å¤ªå¤§
                if (key.includes('background') || key.includes('avatar') || key.includes('sticker')) {
                    // å¯¹äºå›¾ç‰‡æ•°æ®ï¼Œé™åˆ¶å¤§å°
                    console.warn('å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼Œè·³è¿‡ä¿å­˜');
                    return false;
                }
            }
            
            // å°è¯•ä¿å­˜
            if (typeof data === 'object') {
                localStorage.setItem(key, JSON.stringify(data));
            } else {
                localStorage.setItem(key, data);
            }
            
            return true;
            
        } catch (e) {
            console.error(`ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥ [${key}]:`, e);
            
            // å¦‚æœæ˜¯é…é¢è¶…é™é”™è¯¯
            if (e.name === 'QuotaExceededError') {
                console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®...');
                this.clearOldData();
                
                // æ¸…ç†åé‡è¯•ä¸€æ¬¡
                try {
                    if (typeof data === 'object') {
                        localStorage.setItem(key, JSON.stringify(data));
                    } else {
                        localStorage.setItem(key, data);
                    }
                    console.log('é‡è¯•ä¿å­˜æˆåŠŸ');
                    return true;
                } catch (e2) {
                    console.error('é‡è¯•ä¿å­˜ä»ç„¶å¤±è´¥:', e2);
                    return false;
                }
            }
            
            return false;
        }
    }
    
    /**
     * æ¸…ç†æ—§æ•°æ® - åªåœ¨ç©ºé—´ä¸è¶³æ—¶è°ƒç”¨
     */
    clearOldData() {
        try {
            // è·å–æ‰€æœ‰ç›¸å…³çš„å­˜å‚¨é”®
            const allKeys = Object.keys(localStorage);
            const relevantKeys = allKeys.filter(key => 
                key.includes('seven_and_wish_') && 
                !key.includes(this.SELF_INFO_KEY) && 
                !key.includes(this.OTHER_INFO_KEY) &&
                !key.includes(this.MESSAGES_KEY)
            );
            
            // æŒ‰é‡è¦æ€§æ’åºå¹¶åˆ é™¤ä¸é‡è¦çš„æ•°æ®
            const priorityOrder = [
                this.DRAWN_CARDS_KEY,      // å¡”ç½—ç‰Œè®°å½•ï¼ˆå¯ä»¥é‡ç½®ï¼‰
                this.READ_NO_REPLY_KEY,    // å·²è¯»ä¸å›è®°å½•ï¼ˆå¯ä»¥é‡ç½®ï¼‰
                this.TODAY_DATE_KEY,       // ä»Šæ—¥æ—¥æœŸï¼ˆå¯ä»¥é‡ç½®ï¼‰
                this.LOVE_DAYS_KEY,        // æ‹çˆ±å¤©æ•°ï¼ˆå¯ä»¥é‡æ–°è®¡ç®—ï¼‰
                this.STICKERS_KEY,         // è¡¨æƒ…åŒ…ï¼ˆå ç”¨ç©ºé—´å¤§ï¼Œä¼˜å…ˆæ¸…ç†ï¼‰
            ];
            
            // å…ˆæ¸…ç†ä¼˜å…ˆçº§ä½çš„
            for (const key of priorityOrder) {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`å·²æ¸…ç†æ—§æ•°æ®: ${key}`);
                    break; // ä¸€æ¬¡åªæ¸…ç†ä¸€ä¸ªï¼Œé¿å…åˆ é™¤è¿‡å¤š
                }
            }
        } catch (e) {
            console.error('æ¸…ç†æ—§æ•°æ®å¤±è´¥:', e);
        }
    }
    
    // ========================
    // å„ä¸ªæ•°æ®æ¨¡å—çš„å­˜å–æ–¹æ³•
    // ========================
    
    // ---- ç”¨æˆ·ä¿¡æ¯ ----
    getSelfInfo() {
        return this.getStoredData(this.SELF_INFO_KEY) || {
            nickname: 'æˆ‘',
            avatar: null,
            status: 'åœ¨çº¿'
        };
    }
    
    saveSelfInfo(data) {
        return this.setStoredData(this.SELF_INFO_KEY, data);
    }
    
    getOtherInfo() {
        return this.getStoredData(this.OTHER_INFO_KEY) || {
            nickname: 'å¯¹æ–¹',
            avatar: null,
            status: 'åœ¨DR',
            mood: 85
        };
    }
    
    saveOtherInfo(data) {
        return this.setStoredData(this.OTHER_INFO_KEY, data);
    }
    
    // ---- æ¶ˆæ¯è®°å½• ----
    getMessages() {
        return this.getStoredData(this.MESSAGES_KEY) || [];
    }
    
    saveMessage(message) {
        const messages = this.getMessages();
        messages.push(message);
        
        // é™åˆ¶æ¶ˆæ¯æ•°é‡
        if (messages.length > this.MAX_MESSAGES) {
            const removedCount = messages.length - this.MAX_MESSAGES;
            messages.splice(0, removedCount);
        }
        
        return this.setStoredData(this.MESSAGES_KEY, messages);
    }
    
    saveAllMessages(messages) {
        // é™åˆ¶æ¶ˆæ¯æ•°é‡
        if (messages.length > this.MAX_MESSAGES) {
            messages = messages.slice(-this.MAX_MESSAGES);
        }
        return this.setStoredData(this.MESSAGES_KEY, messages);
    }
    
    deleteMessage(messageId) {
        const messages = this.getMessages();
        const filtered = messages.filter(msg => msg.id !== messageId);
        
        if (filtered.length < messages.length) {
            return this.setStoredData(this.MESSAGES_KEY, filtered);
        }
        return false;
    }
    
    getMessageById(messageId) {
        const messages = this.getMessages();
        return messages.find(msg => msg.id === messageId) || null;
    }
    
    // ---- å›å¤è¯æ¡ ----
    getPhrases() {
        return this.getStoredData(this.PHRASES_KEY) || [];
    }
    
    savePhrases(phrases) {
        return this.setStoredData(this.PHRASES_KEY, phrases);
    }
    
    // ---- è¡¨æƒ…åŒ… ----
    getStickers() {
        return this.getStoredData(this.STICKERS_KEY) || [];
    }
    
    saveStickers(stickers) {
        return this.setStoredData(this.STICKERS_KEY, stickers);
    }
    
    // ---- å‘é€è®¾ç½® ----
    getSendSettings() {
        return this.getStoredData(this.SEND_SETTINGS_KEY) || {
            stickerRatio: 50,
            phraseRatio: 50,
            maxMessageCount: 3,
            autoSendFrequency: 600000
        };
    }
    
    saveSendSettings(settings) {
        return this.setStoredData(this.SEND_SETTINGS_KEY, settings);
    }
    
    // ---- å¤–è§‚è®¾ç½® ----
    getAppearanceSettings() {
        const data = this.getStoredData(this.APPEARANCE_KEY);
        if (data && data.loveStartDate) {
            // æ¢å¤Dateå¯¹è±¡
            data.loveStartDate = new Date(data.loveStartDate);
        }
        return data || {
            appTitle: 'æ¢¦è§’çˆ±äºº',
            appSubtitle: 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´',
            loveStartDate: new Date(2024, 0, 1),
            moodChangeFrequency: 600000
        };
    }
    
    saveAppearanceSettings(settings) {
        // ä¿å­˜æ—¶æŠŠDateè½¬æˆISOå­—ç¬¦ä¸²
        const dataToSave = {
            ...settings,
            loveStartDate: settings.loveStartDate instanceof Date 
                ? settings.loveStartDate.toISOString() 
                : settings.loveStartDate
        };
        return this.setStoredData(this.APPEARANCE_KEY, dataToSave);
    }
    
    // ---- èƒŒæ™¯è®¾ç½® ----
    getBackgroundSettings() {
        return this.getStoredData(this.BACKGROUND_KEY) || {
            backgroundImage: null,
            opacity: 100
        };
    }
    
    saveBackgroundSettings(settings) {
        return this.setStoredData(this.BACKGROUND_KEY, settings);
    }
    
    // ---- å¡”ç½—ç‰Œè®¾ç½® ----
    getTarotSettings() {
        return this.getStoredData(this.TAROT_KEY) || {
            enabled: false,
            drawCount: 1,
            customPhrases: []
        };
    }
    
    saveTarotSettings(settings) {
        return this.setStoredData(this.TAROT_KEY, settings);
    }
    
    // ---- å·²æŠ½å–å¡”ç½—ç‰Œè®°å½•ï¼ˆSetï¼‰ ----
    getDrawnCards() {
        const cards = this.getStoredData(this.DRAWN_CARDS_KEY) || [];
        // ä»æ•°ç»„æ¢å¤ä¸ºSet
        return new Set(cards);
    }
    
    saveDrawnCards(cardSet) {
        // å°†Setè½¬æ¢ä¸ºæ•°ç»„å­˜å‚¨
        const cardsArray = Array.from(cardSet);
        return this.setStoredData(this.DRAWN_CARDS_KEY, cardsArray);
    }
    
    // ---- é€šä¿¡è®¾ç½® ----
    getCommunicationSettings() {
        return this.getStoredData(this.COMMUNICATION_KEY) || {
            autoAcceptCalls: true,
            autoAcceptVideos: true,
            todayCalls: 0,
            todayVideos: 0,
            totalCallTime: 0,
            totalVideoTime: 0,
            todayIncomingCalls: 0,
            activeCallSettings: {
                enabled: true,
                overallFrequency: 30,
                callPreference: 50,
                presetMode: 'custom',
                minInterval: 15,
                maxInterval: 45,
                respectBusyStatus: true,
                timeSensitivity: true,
                adaptToActivity: true
            }
        };
    }
    
    saveCommunicationSettings(settings) {
        return this.setStoredData(this.COMMUNICATION_KEY, settings);
    }
    
    // ---- æ‹çˆ±å¤©æ•° ----
    getLoveDays() {
        return this.getStoredData(this.LOVE_DAYS_KEY) || 1;
    }
    
    saveLoveDays(days) {
        return this.setStoredData(this.LOVE_DAYS_KEY, days);
    }
    
    // ---- å·²è¯»ä¸å›è®°å½• ----
    getReadNoReplyIds() {
        return this.getStoredData(this.READ_NO_REPLY_KEY) || [];
    }
    
    saveReadNoReplyIds(ids) {
        return this.setStoredData(this.READ_NO_REPLY_KEY, ids);
    }
    
    // ---- ä»Šæ—¥æ—¥æœŸ ----
    getTodayDate() {
        return this.getStoredData(this.TODAY_DATE_KEY) || new Date().toDateString();
    }
    
    saveTodayDate(dateStr) {
        return this.setStoredData(this.TODAY_DATE_KEY, dateStr);
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºé‡ç½®åŠŸèƒ½ï¼‰
     */
    clearAllData() {
        try {
            // è·å–æ‰€æœ‰ç›¸å…³é”®
            const keysToRemove = Object.keys(localStorage).filter(key => 
                key.includes('seven_and_wish_')
            );
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // é‡æ–°åˆ›å»ºé»˜è®¤æ•°æ®
            this.createDefaultData();
            
            return true;
        } catch (e) {
            console.error('æ¸…é™¤æ‰€æœ‰æ•°æ®å¤±è´¥:', e);
            return false;
        }
    }
}

// ========================
// ç¬¬äºŒéƒ¨åˆ†ï¼šåº”ç”¨ä¸»ç±» - æ•´åˆå­˜å‚¨é€»è¾‘ï¼Œåˆ é™¤æ‰€æœ‰é‡ç½®é—®é¢˜
// ========================

class ChatApp {
    constructor() {
        // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
        this.dataManager = new ChatDataManager();
        
        // åº”ç”¨æ•°æ® - æ‰€æœ‰æ•°æ®éƒ½ä»dataManageråŠ è½½ï¼Œä¸åœ¨è¿™é‡Œå®šä¹‰é»˜è®¤å€¼
        this.appData = {
            // è¿™äº›å±æ€§ä¼šåœ¨loadAllData()ä¸­ä»localStorageåŠ è½½
            selfInfo: null,
            otherInfo: null,
            messages: null,
            responsePhrases: null,
            stickers: null,
            sendSettings: null,
            appearanceSettings: null,
            backgroundSettings: null,
            tarotSettings: null,
            communicationSettings: null,
            drawnCards: null,
            loveDays: null,
            readNoReplyMessageIds: null,
            todayDate: null,
            
            // è¿è¡Œæ—¶çŠ¶æ€ï¼ˆä¸ä¿å­˜ï¼‰
            isTyping: false,
            waitingForReply: false,
            quotedMessage: null,
            activeCall: null,
            activeVideo: null,
            callTimer: null,
            callStartTime: null,
            activeMessageActions: null,
            statusTimer: null,
            moodTimer: null,
            autoSendTimer: null,
            activeCallTimer: null,
            editingUserType: null
        };
        
        // å¸¸é‡å®šä¹‰
        this.DEFAULT_TAROT_CARDS = [
            "æ„šäºº æ­£ä½", "æ„šäºº é€†ä½", "é­”æœ¯å¸ˆ æ­£ä½", "é­”æœ¯å¸ˆ é€†ä½",
            "å¥³ç¥­å¸ æ­£ä½", "å¥³ç¥­å¸ é€†ä½", "å¥³çš‡ æ­£ä½", "å¥³çš‡ é€†ä½",
            "çš‡å¸ æ­£ä½", "çš‡å¸ é€†ä½", "æ•™çš‡ æ­£ä½", "æ•™çš‡ é€†ä½",
            "æ‹äºº æ­£ä½", "æ‹äºº é€†ä½", "æˆ˜è½¦ æ­£ä½", "æˆ˜è½¦ é€†ä½",
            "åŠ›é‡ æ­£ä½", "åŠ›é‡ é€†ä½", "éšå£« æ­£ä½", "éšå£« é€†ä½",
            "å‘½è¿ä¹‹è½® æ­£ä½", "å‘½è¿ä¹‹è½® é€†ä½", "æ­£ä¹‰ æ­£ä½", "æ­£ä¹‰ é€†ä½",
            "å€’åŠäºº æ­£ä½", "å€’åŠäºº é€†ä½", "æ­»ç¥ æ­£ä½", "æ­»ç¥ é€†ä½",
            "èŠ‚åˆ¶ æ­£ä½", "èŠ‚åˆ¶ é€†ä½", "æ¶é­” æ­£ä½", "æ¶é­” é€†ä½",
            "é«˜å¡” æ­£ä½", "é«˜å¡” é€†ä½", "æ˜Ÿæ˜Ÿ æ­£ä½", "æ˜Ÿæ˜Ÿ é€†ä½",
            "æœˆäº® æ­£ä½", "æœˆäº® é€†ä½", "å¤ªé˜³ æ­£ä½", "å¤ªé˜³ é€†ä½",
            "å®¡åˆ¤ æ­£ä½", "å®¡åˆ¤ é€†ä½", "ä¸–ç•Œ æ­£ä½", "ä¸–ç•Œ é€†ä½",
            "æƒæ–ä¸€ æ­£ä½", "æƒæ–ä¸€ é€†ä½", "æƒæ–äºŒ æ­£ä½", "æƒæ–äºŒ é€†ä½",
            "æƒæ–ä¸‰ æ­£ä½", "æƒæ–ä¸‰ é€†ä½", "æƒæ–å›› æ­£ä½", "æƒæ–å›› é€†ä½",
            "æƒæ–äº” æ­£ä½", "æƒæ–äº” é€†ä½", "æƒæ–å…­ æ­£ä½", "æƒæ–å…­ é€†ä½",
            "æƒæ–ä¸ƒ æ­£ä½", "æƒæ–ä¸ƒ é€†ä½", "æƒæ–å…« æ­£ä½", "æƒæ–å…« é€†ä½",
            "æƒæ–ä¹ æ­£ä½", "æƒæ–ä¹ é€†ä½", "æƒæ–å æ­£ä½", "æƒæ–å é€†ä½",
            "æƒæ–ä¾ä» æ­£ä½", "æƒæ–ä¾ä» é€†ä½", "æƒæ–éª‘å£« æ­£ä½", "æƒæ–éª‘å£« é€†ä½",
            "æƒæ–çš‡å æ­£ä½", "æƒæ–çš‡å é€†ä½", "æƒæ–å›½ç‹ æ­£ä½", "æƒæ–å›½ç‹ é€†ä½",
            "åœ£æ¯ä¸€ æ­£ä½", "åœ£æ¯ä¸€ é€†ä½", "åœ£æ¯äºŒ æ­£ä½", "åœ£æ¯äºŒ é€†ä½",
            "åœ£æ¯ä¸‰ æ­£ä½", "åœ£æ¯ä¸‰ é€†ä½", "åœ£æ¯å›› æ­£ä½", "åœ£æ¯å›› é€†ä½",
            "åœ£æ¯äº” æ­£ä½", "åœ£æ¯äº” é€†ä½", "åœ£æ¯å…­ æ­£ä½", "åœ£æ¯å…­ é€†ä½",
            "åœ£æ¯ä¸ƒ æ­£ä½", "åœ£æ¯ä¸ƒ é€†ä½", "åœ£æ¯å…« æ­£ä½", "åœ£æ¯å…« é€†ä½",
            "åœ£æ¯ä¹ æ­£ä½", "åœ£æ¯ä¹ é€†ä½", "åœ£æ¯å æ­£ä½", "åœ£æ¯å é€†ä½",
            "åœ£æ¯ä¾ä» æ­£ä½", "åœ£æ¯ä¾ä» é€†ä½", "åœ£æ¯éª‘å£« æ­£ä½", "åœ£æ¯éª‘å£« é€†ä½",
            "åœ£æ¯çš‡å æ­£ä½", "åœ£æ¯çš‡å é€†ä½", "åœ£æ¯å›½ç‹ æ­£ä½", "åœ£æ¯å›½ç‹ é€†ä½",
            "å®å‰‘ä¸€ æ­£ä½", "å®å‰‘ä¸€ é€†ä½", "å®å‰‘äºŒ æ­£ä½", "å®å‰‘äºŒ é€†ä½",
            "å®å‰‘ä¸‰ æ­£ä½", "å®å‰‘ä¸‰ é€†ä½", "å®å‰‘å›› æ­£ä½", "å®å‰‘å›› é€†ä½",
            "å®å‰‘äº” æ­£ä½", "å®å‰‘äº” é€†ä½", "å®å‰‘å…­ æ­£ä½", "å®å‰‘å…­ é€†ä½",
            "å®å‰‘ä¸ƒ æ­£ä½", "å®å‰‘ä¸ƒ é€†ä½", "å®å‰‘å…« æ­£ä½", "å®å‰‘å…« é€†ä½",
            "å®å‰‘ä¹ æ­£ä½", "å®å‰‘ä¹ é€†ä½", "å®å‰‘å æ­£ä½", "å®å‰‘å é€†ä½",
            "å®å‰‘ä¾ä» æ­£ä½", "å®å‰‘ä¾ä» é€†ä½", "å®å‰‘éª‘å£« æ­£ä½", "å®å‰‘éª‘å£« é€†ä½",
            "å®å‰‘çš‡å æ­£ä½", "å®å‰‘çš‡å é€†ä½", "å®å‰‘å›½ç‹ æ­£ä½", "å®å‰‘å›½ç‹ é€†ä½",
            "æ˜Ÿå¸ä¸€ æ­£ä½", "æ˜Ÿå¸ä¸€ é€†ä½", "æ˜Ÿå¸äºŒ æ­£ä½", "æ˜Ÿå¸äºŒ é€†ä½",
            "æ˜Ÿå¸ä¸‰ æ­£ä½", "æ˜Ÿå¸ä¸‰ é€†ä½", "æ˜Ÿå¸å›› æ­£ä½", "æ˜Ÿå¸å›› é€†ä½",
            "æ˜Ÿå¸äº” æ­£ä½", "æ˜Ÿå¸äº” é€†ä½", "æ˜Ÿå¸å…­ æ­£ä½", "æ˜Ÿå¸å…­ é€†ä½",
            "æ˜Ÿå¸ä¸ƒ æ­£ä½", "æ˜Ÿå¸ä¸ƒ é€†ä½", "æ˜Ÿå¸å…« æ­£ä½", "æ˜Ÿå¸å…« é€†ä½",
            "æ˜Ÿå¸ä¹ æ­£ä½", "æ˜Ÿå¸ä¹ é€†ä½", "æ˜Ÿå¸å æ­£ä½", "æ˜Ÿå¸å é€†ä½",
            "æ˜Ÿå¸ä¾ä» æ­£ä½", "æ˜Ÿå¸ä¾ä» é€†ä½", "æ˜Ÿå¸éª‘å£« æ­£ä½", "æ˜Ÿå¸éª‘å£« é€†ä½",
            "æ˜Ÿå¸çš‡å æ­£ä½", "æ˜Ÿå¸çš‡å é€†ä½", "æ˜Ÿå¸å›½ç‹ æ­£ä½", "æ˜Ÿå¸å›½ç‹ é€†ä½"
        ];
        
        this.PRESET_MODES = {
            quiet: { name: 'å®‰é™æ¨¡å¼', overallFrequency: 10, callPreference: 30, minInterval: 45, maxInterval: 120 },
            daily: { name: 'æ—¥å¸¸æ¨¡å¼', overallFrequency: 30, callPreference: 50, minInterval: 20, maxInterval: 60 },
            intimate: { name: 'äº²å¯†æ¨¡å¼', overallFrequency: 50, callPreference: 70, minInterval: 10, maxInterval: 30 },
            custom: { name: 'è‡ªå®šä¹‰' }
        };
        
        // çŠ¶æ€é€‰é¡¹
        this.statusOptions = [
            { text: 'åœ¨DR', class: 'dr', color: '#2196f3' },
            { text: 'åœ¨CR', class: 'cr', color: '#9c27b0' },
            { text: 'åœ¨çº¿', class: 'online', color: '#4caf50' },
            { text: 'åœ¨å¿™', class: 'busy', color: '#ff9800' },
            { text: 'åœ¨æˆ‘èº«è¾¹', class: 'nearby', color: '#ff5722' }
        ];
        
        // çŠ¶æ€åˆ‡æ¢æ—¶é—´
        this.statusChangeTimes = [120, 300, 600, 900, 1800, 2700, 3600, 5400, 7200];
        
        // å¯åŠ¨åº”ç”¨
        this.init();
    }
    
    /**
     * ä»localStorageåŠ è½½æ‰€æœ‰æ•°æ®
     * å…³é”®æ”¹è¿›ï¼šåªåŠ è½½ï¼Œä¸é‡ç½®ï¼Œä¸è¦†ç›–å·²æœ‰æ•°æ®
     */
    loadAllData() {
        console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®...');
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        this.appData.selfInfo = this.dataManager.getSelfInfo();
        this.appData.otherInfo = this.dataManager.getOtherInfo();
        
        // åŠ è½½æ¶ˆæ¯è®°å½•
        this.appData.messages = this.dataManager.getMessages();
        
        // åŠ è½½å›å¤è¯æ¡
        this.appData.responsePhrases = this.dataManager.getPhrases();
        
        // åŠ è½½è¡¨æƒ…åŒ…
        this.appData.stickers = this.dataManager.getStickers();
        
        // åŠ è½½å‘é€è®¾ç½®
        this.appData.sendSettings = this.dataManager.getSendSettings();
        
        // åŠ è½½å¤–è§‚è®¾ç½®
        this.appData.appearanceSettings = this.dataManager.getAppearanceSettings();
        
        // åŠ è½½èƒŒæ™¯è®¾ç½®
        this.appData.backgroundSettings = this.dataManager.getBackgroundSettings();
        
        // åŠ è½½å¡”ç½—ç‰Œè®¾ç½®
        this.appData.tarotSettings = this.dataManager.getTarotSettings();
        
        // åŠ è½½é€šä¿¡è®¾ç½®
        this.appData.communicationSettings = this.dataManager.getCommunicationSettings();
        
        // åŠ è½½å·²æŠ½å–å¡”ç½—ç‰Œè®°å½•ï¼ˆSetï¼‰
        this.appData.drawnCards = this.dataManager.getDrawnCards();
        
        // åŠ è½½æ‹çˆ±å¤©æ•°
        this.appData.loveDays = this.dataManager.getLoveDays();
        
        // åŠ è½½å·²è¯»ä¸å›è®°å½•
        this.appData.readNoReplyMessageIds = this.dataManager.getReadNoReplyIds();
        
        // åŠ è½½ä»Šæ—¥æ—¥æœŸ
        this.appData.todayDate = this.dataManager.getTodayDate();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
        this.checkResetDailyStats();
        
        // è®¡ç®—æ‹çˆ±å¤©æ•°
        this.calculateLoveDays();
        
        console.log('æ•°æ®åŠ è½½å®Œæˆ:', {
            æ¶ˆæ¯æ•°é‡: this.appData.messages.length,
            è¡¨æƒ…åŒ…æ•°é‡: this.appData.stickers.length,
            è¯æ¡æ•°é‡: this.appData.responsePhrases.length,
            å¡”ç½—ç‰Œå­—å¡: this.appData.tarotSettings.customPhrases.length,
            å¡”ç½—ç‰Œæ¨¡å¼: this.appData.tarotSettings.enabled ? 'å¼€å¯' : 'å…³é—­'
        });
    }
    
    /**
     * ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°localStorage
     */
    saveAllData() {
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        this.dataManager.saveSelfInfo(this.appData.selfInfo);
        this.dataManager.saveOtherInfo(this.appData.otherInfo);
        
        // ä¿å­˜æ¶ˆæ¯è®°å½•
        this.dataManager.saveAllMessages(this.appData.messages);
        
        // ä¿å­˜å›å¤è¯æ¡
        this.dataManager.savePhrases(this.appData.responsePhrases);
        
        // ä¿å­˜è¡¨æƒ…åŒ…
        this.dataManager.saveStickers(this.appData.stickers);
        
        // ä¿å­˜å‘é€è®¾ç½®
        this.dataManager.saveSendSettings(this.appData.sendSettings);
        
        // ä¿å­˜å¤–è§‚è®¾ç½®
        this.dataManager.saveAppearanceSettings(this.appData.appearanceSettings);
        
        // ä¿å­˜èƒŒæ™¯è®¾ç½®
        this.dataManager.saveBackgroundSettings(this.appData.backgroundSettings);
        
        // ä¿å­˜å¡”ç½—ç‰Œè®¾ç½®
        this.dataManager.saveTarotSettings(this.appData.tarotSettings);
        
        // ä¿å­˜é€šä¿¡è®¾ç½®
        this.dataManager.saveCommunicationSettings(this.appData.communicationSettings);
        
        // ä¿å­˜å·²æŠ½å–å¡”ç½—ç‰Œè®°å½•
        this.dataManager.saveDrawnCards(this.appData.drawnCards);
        
        // ä¿å­˜æ‹çˆ±å¤©æ•°
        this.dataManager.saveLoveDays(this.appData.loveDays);
        
        // ä¿å­˜å·²è¯»ä¸å›è®°å½•
        this.dataManager.saveReadNoReplyIds(this.appData.readNoReplyMessageIds);
        
        // ä¿å­˜ä»Šæ—¥æ—¥æœŸ
        this.dataManager.saveTodayDate(this.appData.todayDate);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
     */
    checkResetDailyStats() {
        const currentDate = new Date().toDateString();
        if (this.appData.todayDate !== currentDate) {
            // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ¯æ—¥ç»Ÿè®¡
            this.appData.communicationSettings.todayCalls = 0;
            this.appData.communicationSettings.todayVideos = 0;
            this.appData.communicationSettings.todayIncomingCalls = 0;
            this.appData.todayDate = currentDate;
            console.log('å·²é‡ç½®æ¯æ—¥é€šè¯ç»Ÿè®¡');
        }
    }
    
    /**
     * è®¡ç®—æ‹çˆ±å¤©æ•°
     */
    calculateLoveDays() {
        const today = new Date();
        const startDate = this.appData.appearanceSettings.loveStartDate;
        
        if (startDate && startDate instanceof Date) {
            const timeDiff = today.getTime() - startDate.getTime();
            this.appData.loveDays = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
            if (this.appData.loveDays < 1) this.appData.loveDays = 1;
        }
    }
    
    /**
     * åˆå§‹åŒ–åº”ç”¨
     */
    init() {
        console.log('åˆå§‹åŒ–åº”ç”¨...');
        
        // 1. åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆæœ€å…³é”®çš„ä¸€æ­¥ï¼‰
        this.loadAllData();
        
        // 2. æ‰“å¼€é¡µé¢æ—¶å°†æ‰€æœ‰å¯¹æ–¹å‘é€çš„æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»
        this.markOtherMessagesAsRead();
        
        // 3. æ¸²æŸ“æ‰€æœ‰UI
        this.renderAllUI();
        
        // 4. å¯åŠ¨æ‰€æœ‰å®šæ—¶å™¨
        this.startAllTimers();
        
        // 5. è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        this.setupEventListeners();
        
        // 6. æ˜¾ç¤ºåŠ è½½æˆåŠŸé€šçŸ¥
        this.showNotification('èŠå¤©è®°å½•å·²åŠ è½½');
        
        // 7. è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
            this.saveAllData();
        }, 30000);
        
        // 8. é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            this.saveAllData();
        });
        
        // 9. é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¿å­˜
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                this.saveAllData();
            }
        });
    }
    
    /**
     * å°†æ‰€æœ‰å¯¹æ–¹å‘é€çš„æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»
     */
    markOtherMessagesAsRead() {
        if (this.appData.messages) {
            this.appData.messages.forEach(msg => {
                if (msg.sender === 'other') {
                    msg.read = true;
                }
            });
        }
    }
    
    /**
     * æ¸²æŸ“æ‰€æœ‰UI
     */
    renderAllUI() {
        this.renderMessages();
        this.renderStickerPreview();
        this.renderPhrasesTextarea();
        this.renderTarotUI();
        this.renderBackgroundUI();
        this.renderUserInfo();
        this.renderAppearance();
        this.renderCommunicationStats();
        this.initSendSettingsUI();
        this.initAppearanceSettingsUI();
        this.initCommunicationSettingsUI();
        this.initActiveCallSettingsUI();
        
        this.updateStickerCount();
        this.updatePhraseCount();
        this.updateTarotPhraseCount();
    }
    
    // ========================
    // UI æ¸²æŸ“æ–¹æ³•ï¼ˆä¿ç•™åŸæ–‡ä»¶çš„å®ç°ï¼‰
    // ========================
    
    renderMessages() {
        const messagesArea = document.getElementById('messagesArea');
        if (!messagesArea) return;
        
        messagesArea.innerHTML = '';
        
        // æ·»åŠ "å¯¹æ–¹æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            messagesArea.appendChild(typingIndicator);
            typingIndicator.classList.toggle('active', this.appData.isTyping);
        }
        
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤º
        if (!this.appData.messages || this.appData.messages.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'message other';
            emptyMessage.innerHTML = `
                è¿˜æ²¡æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹èŠå¤©å§ï¼
                <div class="message-time">
                    <span>${this.getCurrentTime()}</span>
                </div>
            `;
            messagesArea.appendChild(emptyMessage);
        } else {
            // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            this.appData.messages.forEach(msg => {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${msg.sender}`;
                
                // å¤´åƒ
                const messageAvatar = document.createElement('div');
                messageAvatar.className = 'message-avatar';
                
                const avatarInfo = msg.sender === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
                if (avatarInfo && avatarInfo.avatar) {
                    messageAvatar.innerHTML = `<img src="${avatarInfo.avatar}" alt="${avatarInfo.nickname}">`;
                } else {
                    messageAvatar.innerHTML = `<span></span>`;
                }
                
                // æ¶ˆæ¯å†…å®¹
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                
                // åˆ›å»ºæ¶ˆæ¯æ“ä½œèœå•
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                    <button class="message-action-btn quote" data-id="${msg.id}">å¼•ç”¨</button>
                    <button class="message-action-btn delete" data-id="${msg.id}">åˆ é™¤</button>
                    ${msg.sender === 'self' ? '<button class="message-action-btn recall" data-id="${msg.id}">æ’¤å›</button>' : ''}
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºæ˜¾ç¤ºæ“ä½œèœå•
                messageDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (this.appData.activeMessageActions && this.appData.activeMessageActions !== messageActions) {
                        this.appData.activeMessageActions.style.display = 'none';
                    }
                    
                    if (messageActions.style.display === 'flex') {
                        messageActions.style.display = 'none';
                        this.appData.activeMessageActions = null;
                    } else {
                        messageActions.style.display = 'flex';
                        this.appData.activeMessageActions = messageActions;
                    }
                });
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºé€šè¯/è§†é¢‘æ¶ˆæ¯
                const isCallMessage = msg.type === 'call' || msg.type === 'video';
                const isTarotMessage = msg.isTarot;
                
                if (isCallMessage) {
                    messageDiv.classList.add(`${msg.type}-message`);
                } else if (isTarotMessage) {
                    messageDiv.classList.add('tarot-message');
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå·²è¯»ä¸å›æ¶ˆæ¯
                const isReadNoReply = msg.id && this.appData.readNoReplyMessageIds && 
                                      this.appData.readNoReplyMessageIds.includes(msg.id);
                
                // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå¼•ç”¨
                let quotedContent = '';
                if (msg.quotedMessage) {
                    const quoted = msg.quotedMessage;
                    quotedContent = `
                        <div class="quoted-message" data-id="${quoted.id}">
                            ${quoted.isSticker ? 
                              `<img src="${quoted.stickerData}" alt="è¡¨æƒ…åŒ…" style="max-height:20px;">` : 
                              quoted.text || ''}
                        </div>
                    `;
                }
                
                // å¡”ç½—ç‰Œæ¶ˆæ¯æ·»åŠ å›¾æ ‡
                let tarotIcon = '';
                if (isTarotMessage) {
                    tarotIcon = 'ğŸ”® ';
                }
                
                // å¦‚æœæ˜¯è¡¨æƒ…åŒ…ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                if (msg.isSticker && msg.stickerData) {
                    messageDiv.innerHTML = `
                        ${quotedContent}
                        <img src="${msg.stickerData}" alt="è¡¨æƒ…åŒ…" style="max-width: 100px; border-radius: 6px;">
                        <div class="message-time">
                            <span>${msg.time || ''}</span>
                            <span class="message-status">
                                <span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? 'âœ“âœ“' : 'âœ“'}</span>
                                <span>${msg.read ? 'å·²è¯»' : 'æœªè¯»'}</span>
                                ${isReadNoReply ? '<span class="read-no-reply">ğŸ‘€ å·²è¯»ä¸å›</span>' : ''}
                            </span>
                        </div>
                    `;
                } else if (isCallMessage) {
                    messageDiv.innerHTML = `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="material-icons" style="font-size:1.2rem;">${msg.type === 'call' ? 'call' : 'videocam'}</i>
                            <div>
                                <div style="font-weight:500;">${msg.title || ''}</div>
                                <div style="font-size:0.8rem;">${msg.duration || ''}</div>
                            </div>
                        </div>
                        <div class="message-time">
                            <span>${msg.time || ''}</span>
                            <span class="message-status">
                                <span class="status-check double">âœ“âœ“</span>
                                <span>å·²è¯»</span>
                            </span>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        ${quotedContent}
                        ${tarotIcon}${msg.text || ''}
                        <div class="message-time">
                            <span>${msg.time || ''}</span>
                            <span class="message-status">
                                <span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? 'âœ“âœ“' : 'âœ“'}</span>
                                <span>${msg.read ? 'å·²è¯»' : 'æœªè¯»'}</span>
                                ${isReadNoReply ? '<span class="read-no-reply">ğŸ‘€ å·²è¯»ä¸å›</span>' : ''}
                            </span>
                        </div>
                    `;
                }
                
                messageContent.appendChild(messageDiv);
                messageContent.appendChild(messageActions);
                messageContainer.appendChild(messageAvatar);
                messageContainer.appendChild(messageContent);
                messagesArea.appendChild(messageContainer);
                
                // ä¸ºæ“ä½œèœå•æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const quoteBtn = messageActions.querySelector('.message-action-btn.quote');
                if (quoteBtn) {
                    quoteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.quoteMessage(msg);
                        messageActions.style.display = 'none';
                        this.appData.activeMessageActions = null;
                    });
                }
                
                const deleteBtn = messageActions.querySelector('.message-action-btn.delete');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteMessage(msg.id);
                        messageActions.style.display = 'none';
                        this.appData.activeMessageActions = null;
                    });
                }
                
                const recallBtn = messageActions.querySelector('.message-action-btn.recall');
                if (recallBtn) {
                    recallBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.recallMessage(msg.id);
                        messageActions.style.display = 'none';
                        this.appData.activeMessageActions = null;
                    });
                }
            });
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    
    renderStickerPreview() {
        const stickerPreview = document.getElementById('stickerPreview');
        if (!stickerPreview) return;
        
        stickerPreview.innerHTML = '';
        
        // æ·»åŠ å·²æœ‰çš„è¡¨æƒ…åŒ…
        if (this.appData.stickers) {
            this.appData.stickers.forEach(sticker => {
                const stickerItem = document.createElement('div');
                stickerItem.className = 'sticker-item';
                stickerItem.innerHTML = `
                    <img src="${sticker.data}" alt="è¡¨æƒ…åŒ…">
                    <button class="delete-sticker" data-id="${sticker.id}">Ã—</button>
                `;
                
                stickerItem.querySelector('.delete-sticker').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = sticker.id;
                    this.appData.stickers = this.appData.stickers.filter(s => s.id !== id);
                    this.renderStickerPreview();
                    this.saveAllData();
                    this.showNotification('è¡¨æƒ…åŒ…å·²åˆ é™¤');
                });
                
                stickerPreview.appendChild(stickerItem);
            });
        }
        
        // æ·»åŠ æ·»åŠ æŒ‰é’®
        const addButton = document.createElement('div');
        addButton.className = 'sticker-item';
        addButton.id = 'addStickerPlaceholder';
        addButton.innerHTML = '<div class="sticker-placeholder">+</div>';
        addButton.addEventListener('click', () => document.getElementById('stickerUpload')?.click());
        stickerPreview.appendChild(addButton);
        
        this.updateStickerCount();
    }
    
    renderPhrasesTextarea() {
        const textarea = document.getElementById('phrasesTextarea');
        if (textarea && this.appData.responsePhrases) {
            textarea.value = this.appData.responsePhrases.join('\n');
            this.updatePhraseCount();
        }
    }
    
    renderTarotUI() {
        // è®¾ç½®å¼€å…³çŠ¶æ€
        const tarotModeToggle = document.getElementById('tarotModeToggle');
        if (tarotModeToggle) {
            tarotModeToggle.checked = this.appData.tarotSettings?.enabled || false;
        }
        
        // è®¾ç½®æŠ½å–æ•°é‡
        const tarotCountValue = document.getElementById('tarotCountValue');
        if (tarotCountValue) {
            tarotCountValue.textContent = this.appData.tarotSettings?.drawCount || 1;
        }
        
        // ç”Ÿæˆæ•°å­—é€‰æ‹©å™¨
        const tarotNumberSelector = document.getElementById('tarotNumberSelector');
        if (tarotNumberSelector) {
            tarotNumberSelector.innerHTML = '';
            for (let i = 1; i <= 15; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.className = `tarot-number ${i === (this.appData.tarotSettings?.drawCount || 1) ? 'active' : ''}`;
                numberDiv.textContent = i;
                numberDiv.dataset.number = i;
                numberDiv.addEventListener('click', () => this.selectTarotNumber(i));
                tarotNumberSelector.appendChild(numberDiv);
            }
        }
        
        // è®¾ç½®å­—å¡å†…å®¹
        const tarotTextarea = document.getElementById('tarotTextarea');
        if (tarotTextarea && this.appData.tarotSettings?.customPhrases) {
            tarotTextarea.value = this.appData.tarotSettings.customPhrases.join('\n');
        }
        
        // æ›´æ–°è®¡æ•°å’ŒçŠ¶æ€
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
    }
    
    renderBackgroundUI() {
        this.updateBackgroundPreview();
        
        const slider = document.getElementById('backgroundOpacitySlider');
        const value = document.getElementById('backgroundOpacityValue');
        if (slider && value && this.appData.backgroundSettings) {
            slider.value = this.appData.backgroundSettings.opacity || 100;
            value.textContent = `${this.appData.backgroundSettings.opacity || 100}%`;
        }
        
        this.applyBackgroundSettings();
    }
    
    renderUserInfo() {
        // è‡ªå·±
        const selfAvatar = document.getElementById('selfAvatar');
        if (selfAvatar) {
            if (this.appData.selfInfo?.avatar) {
                selfAvatar.innerHTML = `<img src="${this.appData.selfInfo.avatar}" alt="${this.appData.selfInfo.nickname}">`;
            } else {
                selfAvatar.innerHTML = `<span></span>`;
            }
        }
        
        const selfNickname = document.getElementById('selfNickname');
        if (selfNickname) {
            selfNickname.textContent = this.appData.selfInfo?.nickname || 'æˆ‘';
        }
        
        const selfStatusText = document.getElementById('selfStatusText');
        if (selfStatusText) {
            selfStatusText.textContent = this.appData.selfInfo?.status || 'åœ¨çº¿';
        }
        
        // å¯¹æ–¹
        const otherAvatar = document.getElementById('otherAvatar');
        if (otherAvatar) {
            if (this.appData.otherInfo?.avatar) {
                otherAvatar.innerHTML = `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">`;
            } else {
                otherAvatar.innerHTML = `<span></span>`;
            }
        }
        
        const otherNickname = document.getElementById('otherNickname');
        if (otherNickname) {
            otherNickname.textContent = this.appData.otherInfo?.nickname || 'å¯¹æ–¹';
        }
        
        const otherStatusText = document.getElementById('otherStatusText');
        if (otherStatusText) {
            otherStatusText.textContent = this.appData.otherInfo?.status || 'åœ¨DR';
        }
        
        const otherMoodValue = document.getElementById('otherMoodValue');
        if (otherMoodValue) {
            otherMoodValue.textContent = `${this.appData.otherInfo?.mood || 85}%`;
        }
        
        this.updateOtherStatusIndicator();
    }
    
    renderAppearance() {
        const appTitle = document.getElementById('appTitle');
        if (appTitle) {
            appTitle.textContent = this.appData.appearanceSettings?.appTitle || 'æ¢¦è§’çˆ±äºº';
        }
        
        const appSubtitle = document.getElementById('appSubtitle');
        if (appSubtitle) {
            appSubtitle.textContent = this.appData.appearanceSettings?.appSubtitle || 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´';
        }
        
        const loveDaysCount = document.getElementById('loveDaysCount');
        if (loveDaysCount) {
            loveDaysCount.textContent = `æ‹çˆ±ç¬¬ ${this.appData.loveDays || 1} å¤©`;
        }
    }
    
    renderCommunicationStats() {
        const todayCalls = document.getElementById('todayCalls');
        if (todayCalls) {
            todayCalls.textContent = this.appData.communicationSettings?.todayCalls || 0;
        }
        
        const totalCallTime = document.getElementById('totalCallTime');
        if (totalCallTime) {
            totalCallTime.textContent = this.appData.communicationSettings?.totalCallTime || 0;
        }
        
        const todayVideos = document.getElementById('todayVideos');
        if (todayVideos) {
            todayVideos.textContent = this.appData.communicationSettings?.todayVideos || 0;
        }
        
        const totalVideoTime = document.getElementById('totalVideoTime');
        if (totalVideoTime) {
            totalVideoTime.textContent = this.appData.communicationSettings?.totalVideoTime || 0;
        }
        
        const todayIncomingCalls = document.getElementById('todayIncomingCalls');
        if (todayIncomingCalls) {
            todayIncomingCalls.textContent = this.appData.communicationSettings?.todayIncomingCalls || 0;
        }
    }
    
    initSendSettingsUI() {
        const stickerRatioSlider = document.getElementById('stickerRatioSlider');
        const phraseRatioSlider = document.getElementById('phraseRatioSlider');
        const stickerRatioValue = document.getElementById('stickerRatioValue');
        const phraseRatioValue = document.getElementById('phraseRatioValue');
        const maxMessageCount = document.getElementById('maxMessageCount');
        const autoSendFrequency = document.getElementById('autoSendFrequency');
        
        if (stickerRatioSlider && this.appData.sendSettings) {
            stickerRatioSlider.value = this.appData.sendSettings.stickerRatio || 50;
        }
        if (phraseRatioSlider && this.appData.sendSettings) {
            phraseRatioSlider.value = this.appData.sendSettings.phraseRatio || 50;
        }
        if (stickerRatioValue && this.appData.sendSettings) {
            stickerRatioValue.textContent = `${this.appData.sendSettings.stickerRatio || 50}%`;
        }
        if (phraseRatioValue && this.appData.sendSettings) {
            phraseRatioValue.textContent = `${this.appData.sendSettings.phraseRatio || 50}%`;
        }
        if (maxMessageCount && this.appData.sendSettings) {
            maxMessageCount.value = this.appData.sendSettings.maxMessageCount || 3;
        }
        if (autoSendFrequency && this.appData.sendSettings) {
            autoSendFrequency.value = this.appData.sendSettings.autoSendFrequency || 600000;
        }
    }
    
    initAppearanceSettingsUI() {
        const appTitleInput = document.getElementById('appTitleInput');
        const appSubtitleInput = document.getElementById('appSubtitleInput');
        const loveYear = document.getElementById('loveYear');
        const loveMonth = document.getElementById('loveMonth');
        const loveDay = document.getElementById('loveDay');
        const moodChangeFrequency = document.getElementById('moodChangeFrequency');
        
        if (appTitleInput && this.appData.appearanceSettings) {
            appTitleInput.value = this.appData.appearanceSettings.appTitle || 'æ¢¦è§’çˆ±äºº';
        }
        if (appSubtitleInput && this.appData.appearanceSettings) {
            appSubtitleInput.value = this.appData.appearanceSettings.appSubtitle || 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´';
        }
        
        if (this.appData.appearanceSettings?.loveStartDate) {
            const date = new Date(this.appData.appearanceSettings.loveStartDate);
            if (loveYear) loveYear.value = date.getFullYear();
            if (loveMonth) loveMonth.value = date.getMonth() + 1;
            if (loveDay) loveDay.value = date.getDate();
        }
        
        if (moodChangeFrequency && this.appData.appearanceSettings) {
            moodChangeFrequency.value = this.appData.appearanceSettings.moodChangeFrequency || 600000;
        }
    }
    
    initCommunicationSettingsUI() {
        const autoAcceptCalls = document.getElementById('autoAcceptCalls');
        const autoAcceptVideos = document.getElementById('autoAcceptVideos');
        
        if (autoAcceptCalls && this.appData.communicationSettings) {
            autoAcceptCalls.checked = this.appData.communicationSettings.autoAcceptCalls !== false;
        }
        if (autoAcceptVideos && this.appData.communicationSettings) {
            autoAcceptVideos.checked = this.appData.communicationSettings.autoAcceptVideos !== false;
        }
    }
    
    initActiveCallSettingsUI() {
        const overallFrequencySlider = document.getElementById('overallFrequencySlider');
        const callPreferenceSlider = document.getElementById('callPreferenceSlider');
        
        if (overallFrequencySlider && this.appData.communicationSettings?.activeCallSettings) {
            overallFrequencySlider.value = this.appData.communicationSettings.activeCallSettings.overallFrequency || 30;
            this.updateOverallFrequencyDisplay();
        }
        
        if (callPreferenceSlider && this.appData.communicationSettings?.activeCallSettings) {
            callPreferenceSlider.value = this.appData.communicationSettings.activeCallSettings.callPreference || 50;
            this.updateCallPreferenceDisplay();
        }
        
        this.updateActiveCallPreview();
        this.updatePresetButtons();
    }
    
    updateOtherStatusIndicator() {
        const indicator = document.getElementById('otherStatusIndicator');
        if (!indicator) return;
        
        indicator.className = 'status-indicator';
        
        const status = this.statusOptions.find(s => s.text === this.appData.otherInfo?.status);
        if (status) {
            indicator.classList.add(status.class);
            indicator.style.backgroundColor = status.color;
        }
    }
    
    updateStickerCount() {
        const countEl = document.getElementById('stickerCount');
        if (countEl) {
            countEl.textContent = this.appData.stickers?.length || 0;
        }
    }
    
    updatePhraseCount() {
        const textarea = document.getElementById('phrasesTextarea');
        const countEl = document.getElementById('phraseCount');
        
        if (textarea && countEl) {
            const text = textarea.value.trim();
            if (!text) {
                countEl.textContent = '0';
                return;
            }
            
            const phrases = text.split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);
            countEl.textContent = phrases.length;
        }
    }
    
    updateTarotPhraseCount() {
        const countEl = document.getElementById('tarotPhraseCount');
        if (countEl && this.appData.tarotSettings) {
            countEl.textContent = this.appData.tarotSettings.customPhrases?.length || 0;
        }
    }
    
    updateTarotStatus() {
        const statusEl = document.getElementById('tarotStatus');
        if (!statusEl) return;
        
        const enabled = this.appData.tarotSettings?.enabled || false;
        const drawCount = this.appData.tarotSettings?.drawCount || 1;
        const count = this.appData.tarotSettings?.customPhrases?.length || 0;
        
        if (enabled) {
            statusEl.innerHTML = `
                <strong>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼å·²å¼€å¯ ğŸ”®</strong><br>
                å¯¹æ–¹å°†æŠ½å– <strong>${drawCount}</strong> å¼ å¡”ç½—ç‰Œå­—å¡è¿›è¡Œå›å¤<br>
                å¡”ç½—ç‰Œå­—å¡åº“: <strong>${count}</strong> å¼ <br>
                <span style="font-size:0.75rem; opacity:0.8;">æ™ºèƒ½è§„åˆ™ï¼šåŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–</span>
            `;
            statusEl.style.background = 'var(--tarot-bg)';
            statusEl.style.color = 'var(--tarot-text)';
            statusEl.style.borderLeft = '3px solid var(--tarot-text)';
        } else {
            statusEl.innerHTML = `
                <strong>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼å·²å…³é—­</strong><br>
                å¯¹æ–¹ä½¿ç”¨æ™®é€šè¯æ¡å’Œè¡¨æƒ…åŒ…å›å¤
            `;
            statusEl.style.background = 'rgba(255, 255, 255, 0.7)';
            statusEl.style.color = 'var(--text)';
            statusEl.style.borderLeft = '3px solid #ccc';
        }
    }
    
    updateBackgroundPreview() {
        const preview = document.getElementById('backgroundPreview');
        if (!preview) return;
        
        if (this.appData.backgroundSettings?.backgroundImage) {
            preview.innerHTML = `<img src="${this.appData.backgroundSettings.backgroundImage}" alt="èƒŒæ™¯é¢„è§ˆ">`;
            preview.style.backgroundImage = `url(${this.appData.backgroundSettings.backgroundImage})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        } else {
            preview.innerHTML = `
                <div class="empty">
                    <i class="material-icons">wallpaper</i>
                    <span>é»˜è®¤èƒŒæ™¯</span>
                </div>
            `;
        }
    }
    
    applyBackgroundSettings() {
        const container = document.getElementById('backgroundContainer');
        if (!container) return;
        
        if (this.appData.backgroundSettings?.backgroundImage) {
            container.style.backgroundImage = `url(${this.appData.backgroundSettings.backgroundImage})`;
            container.style.backgroundColor = 'transparent';
            container.style.opacity = (this.appData.backgroundSettings.opacity / 100).toString();
        } else {
            container.style.backgroundImage = 'none';
            container.style.backgroundColor = '';
            container.style.opacity = '1';
        }
    }
    
    updateOverallFrequencyDisplay() {
        const value = this.appData.communicationSettings?.activeCallSettings?.overallFrequency || 30;
        const el = document.getElementById('overallFrequencyValue');
        if (el) el.textContent = `${value}%`;
    }
    
    updateCallPreferenceDisplay() {
        const value = this.appData.communicationSettings?.activeCallSettings?.callPreference || 50;
        const el = document.getElementById('callPreferenceValue');
        if (el) {
            const callPercent = value;
            const videoPercent = 100 - value;
            el.textContent = `ç”µè¯ ${callPercent}% / è§†é¢‘ ${videoPercent}%`;
        }
    }
    
    updateActiveCallPreview() {
        const settings = this.appData.communicationSettings?.activeCallSettings;
        if (!settings) return;
        
        const frequency = settings.overallFrequency || 30;
        
        let frequencyDesc = '';
        if (frequency === 0) frequencyDesc = 'å…³é—­';
        else if (frequency <= 15) frequencyDesc = 'å¾ˆä½';
        else if (frequency <= 30) frequencyDesc = 'è¾ƒä½';
        else if (frequency <= 50) frequencyDesc = 'ä¸­ç­‰';
        else if (frequency <= 75) frequencyDesc = 'è¾ƒé«˜';
        else frequencyDesc = 'å¾ˆé«˜';
        
        const previewFrequency = document.getElementById('previewFrequency');
        if (previewFrequency) previewFrequency.textContent = `${frequencyDesc} (${frequency}%)`;
        
        // é¢„è®¡æ¯å¤©å‘¼å«æ¬¡æ•°
        let dailyCalls = 0;
        if (frequency === 0) dailyCalls = 0;
        else if (frequency <= 15) dailyCalls = Math.floor(Math.random() * 2) + 1;
        else if (frequency <= 30) dailyCalls = Math.floor(Math.random() * 3) + 2;
        else if (frequency <= 50) dailyCalls = Math.floor(Math.random() * 4) + 3;
        else if (frequency <= 75) dailyCalls = Math.floor(Math.random() * 5) + 4;
        else dailyCalls = Math.floor(Math.random() * 6) + 5;
        
        const previewDaily = document.getElementById('previewDaily');
        if (previewDaily) previewDaily.textContent = frequency === 0 ? 'æ— å‘¼å«' : `${dailyCalls}æ¬¡å‘¼å«`;
    }
    
    updatePresetButtons() {
        const preset = this.appData.communicationSettings?.activeCallSettings?.presetMode || 'custom';
        const buttons = document.querySelectorAll('.preset-btn');
        
        buttons.forEach(btn => {
            const btnPreset = btn.getAttribute('data-preset');
            btn.classList.toggle('active', btnPreset === preset);
        });
    }
    
    // ========================
    // å®šæ—¶å™¨ç®¡ç†
    // ========================
    
    startAllTimers() {
        this.startStatusSwitching();
        this.startMoodChanging();
        this.startAutoSending();
        this.startActiveCallScheduler();
    }
    
    startStatusSwitching() {
        if (this.appData.statusTimer) clearTimeout(this.appData.statusTimer);
        
        const switchStatus = () => {
            if (Math.random() > 0.3) {
                const timeIndex = Math.floor(Math.random() * this.statusChangeTimes.length);
                const nextTime = this.statusChangeTimes[timeIndex];
                this.appData.statusTimer = setTimeout(switchStatus, nextTime * 1000);
                return;
            }
            
            let newStatus;
            do {
                const randomIndex = Math.floor(Math.random() * this.statusOptions.length);
                newStatus = this.statusOptions[randomIndex];
            } while (newStatus.text === this.appData.otherInfo?.status);
            
            if (this.appData.otherInfo) {
                this.appData.otherInfo.status = newStatus.text;
                this.renderUserInfo();
                this.saveAllData();
            }
            
            const timeIndex = Math.floor(Math.random() * this.statusChangeTimes.length);
            const nextTime = this.statusChangeTimes[timeIndex];
            this.appData.statusTimer = setTimeout(switchStatus, nextTime * 1000);
        };
        
        setTimeout(switchStatus, 10000);
    }
    
    startMoodChanging() {
        if (this.appData.moodTimer) clearInterval(this.appData.moodTimer);
        
        const frequency = this.appData.appearanceSettings?.moodChangeFrequency || 600000;
        this.appData.moodTimer = setInterval(() => {
            if (this.appData.otherInfo) {
                const change = Math.floor(Math.random() * 21) - 10;
                this.appData.otherInfo.mood = Math.max(0, Math.min(100, (this.appData.otherInfo.mood || 85) + change));
                this.renderUserInfo();
                this.saveAllData();
            }
        }, frequency);
    }
    
    startAutoSending() {
        if (this.appData.autoSendTimer) clearInterval(this.appData.autoSendTimer);
        
        const frequency = this.appData.sendSettings?.autoSendFrequency || 600000;
        if (frequency > 0) {
            this.appData.autoSendTimer = setInterval(() => {
                if (Math.random() > 0.5) {
                    this.autoSendMessage();
                }
            }, frequency);
        }
    }
    
    startActiveCallScheduler() {
        if (this.appData.activeCallTimer) clearInterval(this.appData.activeCallTimer);
        
        const settings = this.appData.communicationSettings?.activeCallSettings;
        if (!settings || !settings.enabled || settings.overallFrequency <= 0) return;
        
        const baseInterval = 60000;
        const checkInterval = baseInterval * (100 / Math.max(settings.overallFrequency, 10));
        
        this.appData.activeCallTimer = setInterval(() => {
            const adjustedProbability = this.calculateAdjustedCallProbability();
            if (Math.random() * 100 < adjustedProbability) {
                const callType = this.determineCallType();
                this.simulateIncomingCall(callType);
            }
        }, checkInterval);
    }
    
    calculateAdjustedCallProbability() {
        const settings = this.appData.communicationSettings?.activeCallSettings;
        if (!settings) return 0;
        
        let baseProbability = settings.overallFrequency || 30;
        
        if (settings.respectBusyStatus && this.appData.otherInfo?.status === 'åœ¨å¿™') {
            baseProbability *= 0.3;
        }
        
        if (settings.timeSensitivity) {
            const hour = new Date().getHours();
            if (hour >= 22 || hour < 9) {
                baseProbability *= 0.4;
                if (settings.callPreference > 50) baseProbability *= 0.5;
            } else if (hour >= 9 && hour < 12) {
                baseProbability *= 1.2;
            } else if (hour >= 18 && hour < 22) {
                baseProbability *= 1.3;
            }
        }
        
        return Math.max(0, Math.min(100, baseProbability));
    }
    
    determineCallType() {
        const callPref = this.appData.communicationSettings?.activeCallSettings?.callPreference || 50;
        return Math.random() * 100 < callPref ? 'call' : 'video';
    }
    
    simulateIncomingCall(type) {
        if (this.appData.activeCall || this.appData.activeVideo) return;
        
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayIncomingCalls = (this.appData.communicationSettings.todayIncomingCalls || 0) + 1;
            this.renderCommunicationStats();
            this.saveAllData();
        }
        
        if (type === 'call') {
            this.createCallWindow('incoming');
            this.showNotification('å¯¹æ–¹æ¥ç”µ');
        } else {
            this.createVideoWindow('incoming');
            this.showNotification('å¯¹æ–¹å‘èµ·è§†é¢‘é€šè¯');
        }
    }
    
    // ========================
    // æ¶ˆæ¯æ“ä½œ
    // ========================
    
    sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input) return;
        
        const text = input.value.trim();
        if (!text && !this.appData.quotedMessage) return;
        
        const userMessage = {
            id: this.dataManager.generateMessageId(),
            text: text,
            sender: 'self',
            time: this.getCurrentTime(),
            read: false,
            quotedMessage: this.appData.quotedMessage ? {...this.appData.quotedMessage} : null
        };
        
        this.appData.messages.push(userMessage);
        this.renderMessages();
        
        input.value = '';
        this.appData.quotedMessage = null;
        input.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
        
        this.saveAllData();
        
        const willReply = Math.random() > 0.2;
        if (willReply) {
            this.appData.waitingForReply = true;
            this.startTypingIndicator();
            
            setTimeout(() => {
                if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                    this.generateTarotReply('reply');
                } else {
                    this.generateReply(userMessage.id);
                }
            }, 1500 + Math.random() * 2000);
        } else {
            this.appData.waitingForReply = false;
            
            setTimeout(() => {
                this.markSelfMessagesAsRead();
                
                if (userMessage.id) {
                    if (!this.appData.readNoReplyMessageIds) this.appData.readNoReplyMessageIds = [];
                    this.appData.readNoReplyMessageIds.push(userMessage.id);
                }
                
                this.renderMessages();
                this.showNotification('å¯¹æ–¹å·²è¯»ä¸å›');
                this.saveAllData();
            }, 1000 + Math.random() * 3000);
        }
    }
    
    getCurrentTime() {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    }
    
    startTypingIndicator() {
        this.appData.isTyping = true;
        this.renderMessages();
    }
    
    stopTypingIndicator() {
        this.appData.isTyping = false;
        this.renderMessages();
    }
    
    markSelfMessagesAsRead() {
        if (this.appData.messages) {
            this.appData.messages.forEach(msg => {
                if (msg.sender === 'self') {
                    msg.read = true;
                }
            });
        }
    }
    
    generateReply(messageId) {
        this.stopTypingIndicator();
        this.markSelfMessagesAsRead();
        
        if (messageId && this.appData.readNoReplyMessageIds) {
            const index = this.appData.readNoReplyMessageIds.indexOf(messageId);
            if (index > -1) this.appData.readNoReplyMessageIds.splice(index, 1);
        }
        
        const messageCount = Math.floor(Math.random() * (this.appData.sendSettings?.maxMessageCount || 3)) + 1;
        const totalRatio = (this.appData.sendSettings?.stickerRatio || 50) + (this.appData.sendSettings?.phraseRatio || 50);
        const stickerProbability = (this.appData.sendSettings?.stickerRatio || 50) / totalRatio;
        
        const messagesToSend = [];
        
        for (let i = 0; i < messageCount; i++) {
            const isSticker = Math.random() < stickerProbability && this.appData.stickers?.length > 0;
            
            if (isSticker) {
                const randomSticker = this.appData.stickers[Math.floor(Math.random() * this.appData.stickers.length)];
                messagesToSend.push({ type: 'sticker', data: randomSticker.data });
            } else {
                const randomPhrase = this.appData.responsePhrases[Math.floor(Math.random() * this.appData.responsePhrases.length)];
                messagesToSend.push({ type: 'text', data: randomPhrase });
            }
        }
        
        const firstMsg = messagesToSend[0];
        const firstMessage = {
            id: this.dataManager.generateMessageId(),
            isSticker: firstMsg.type === 'sticker',
            [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
            sender: 'other',
            time: this.getCurrentTime(),
            read: true
        };
        
        if (Math.random() < 0.4) {
            const recentUserMessages = this.appData.messages
                .filter(msg => msg.sender === 'self')
                .slice(-3);
            
            if (recentUserMessages.length > 0) {
                const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
                firstMessage.quotedMessage = {
                    id: randomUserMessage.id,
                    text: randomUserMessage.text || '',
                    isSticker: randomUserMessage.isSticker || false,
                    stickerData: randomUserMessage.stickerData || null,
                    sender: randomUserMessage.sender,
                    time: randomUserMessage.time
                };
            }
        }
        
        this.appData.messages.push(firstMessage);
        this.renderMessages();
        
        if (messagesToSend.length > 1) {
            for (let i = 1; i < messagesToSend.length; i++) {
                setTimeout(() => {
                    const msg = messagesToSend[i];
                    const additionalMessage = {
                        id: this.dataManager.generateMessageId(),
                        isSticker: msg.type === 'sticker',
                        [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
                        sender: 'other',
                        time: this.getCurrentTime(),
                        read: true
                    };
                    
                    this.appData.messages.push(additionalMessage);
                    this.renderMessages();
                    
                    if (i === messagesToSend.length - 1) {
                        const stickerCount = messagesToSend.filter(m => m.type === 'sticker').length;
                        const textCount = messagesToSend.filter(m => m.type === 'text').length;
                        let notificationText = `å¯¹æ–¹å›å¤äº†${messagesToSend.length}æ¡æ¶ˆæ¯`;
                        if (stickerCount > 0 && textCount > 0) {
                            notificationText += `ï¼ˆ${textCount}æ¡æ–‡å­—ï¼Œ${stickerCount}ä¸ªè¡¨æƒ…åŒ…ï¼‰`;
                        } else if (stickerCount > 0) {
                            notificationText += `ï¼ˆ${stickerCount}ä¸ªè¡¨æƒ…åŒ…ï¼‰`;
                        }
                        this.showNotification(notificationText);
                    }
                }, (i * 800) + Math.random() * 500);
            }
        } else {
            const msgType = messagesToSend[0].type === 'sticker' ? 'ä¸€ä¸ªè¡¨æƒ…åŒ…' : '1æ¡æ¶ˆæ¯';
            this.showNotification(`å¯¹æ–¹å›å¤äº†${msgType}`);
        }
        
        this.appData.waitingForReply = false;
        this.saveAllData();
    }
    
    generateTarotReply(source) {
        if (!this.appData.tarotSettings?.enabled || !this.appData.tarotSettings.customPhrases?.length) {
            if (source === 'reply') {
                this.generateReply();
            } else {
                this.autoSendMessage();
            }
            return;
        }
        
        const drawCount = Math.min(this.appData.tarotSettings.drawCount || 1, this.appData.tarotSettings.customPhrases.length);
        let availablePhrases = [...this.appData.tarotSettings.customPhrases];
        
        // åº”ç”¨åŒç‰Œæ­£é€†ä½ä¸é‡å¤è§„åˆ™
        availablePhrases = availablePhrases.filter(phrase => {
            const parsed = this.parseTarotCard(phrase);
            return this.canDrawCard(parsed);
        });
        
        if (availablePhrases.length === 0) {
            // é‡ç½®å·²æŠ½å–è®°å½•
            this.appData.drawnCards = new Set();
            availablePhrases = [...this.appData.tarotSettings.customPhrases];
        }
        
        const finalDrawCount = Math.min(drawCount, availablePhrases.length);
        const selectedPhrases = [];
        
        for (let i = 0; i < finalDrawCount && availablePhrases.length > 0; i++) {
            const randomIndex = Math.floor(Math.random() * availablePhrases.length);
            selectedPhrases.push(availablePhrases[randomIndex]);
            
            const parsed = this.parseTarotCard(availablePhrases[randomIndex]);
            if (parsed.cardName) {
                this.appData.drawnCards.add(parsed.cardName);
            }
            
            availablePhrases.splice(randomIndex, 1);
        }
        
        this.sendTarotMessages(selectedPhrases, source);
    }
    
    parseTarotCard(phrase) {
        const trimmed = phrase.trim();
        
        const patterns = [
            /^([^æ­£é€†ä½]+)(æ­£ä½|é€†ä½)$/,
            /^(æ­£ä½|é€†ä½)[Â·\-](.+)$/,
            /^(æ­£ä½|é€†ä½)[\-](.+)$/,
            /^(.+)[\-]\s*(æ­£ä½|é€†ä½)$/,
            /^(.+)\s*[\(ï¼ˆ](æ­£ä½|é€†ä½)[\)ï¼‰]$/
        ];
        
        for (const pattern of patterns) {
            const match = trimmed.match(pattern);
            if (match) {
                let cardName = '', position = '';
                
                if (pattern.toString().includes('[^æ­£é€†ä½]+')) {
                    cardName = match[1].trim();
                    position = match[2].trim();
                } else if (pattern.toString().includes('^(æ­£ä½|é€†ä½)')) {
                    position = match[1].trim();
                    cardName = match[2].trim();
                } else {
                    cardName = match[1].trim();
                    position = match[2].trim();
                }
                
                cardName = cardName.replace(/^[Â·\-]\s*|\s*[Â·\-]$/g, '').trim();
                
                return { original: trimmed, cardName, position, isValid: true };
            }
        }
        
        return { original: trimmed, cardName: trimmed, position: '', isValid: false };
    }
    
    canDrawCard(parsedCard) {
        if (!parsedCard.isValid || !parsedCard.cardName) return true;
        return !this.appData.drawnCards?.has(parsedCard.cardName);
    }
    
    sendTarotMessages(selectedPhrases, source) {
        const firstMessage = {
            id: this.dataManager.generateMessageId(),
            text: selectedPhrases[0],
            sender: 'other',
            time: this.getCurrentTime(),
            read: true,
            isTarot: true
        };
        
        if (Math.random() < 0.25) {
            const recentUserMessages = this.appData.messages
                .filter(msg => msg.sender === 'self')
                .slice(-3);
            
            if (recentUserMessages.length > 0) {
                const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
                firstMessage.quotedMessage = {
                    id: randomUserMessage.id,
                    text: randomUserMessage.text || '',
                    isSticker: randomUserMessage.isSticker || false,
                    stickerData: randomUserMessage.stickerData || null,
                    sender: randomUserMessage.sender,
                    time: randomUserMessage.time
                };
            }
        }
        
        this.appData.messages.push(firstMessage);
        this.renderMessages();
        
        if (selectedPhrases.length > 1) {
            for (let i = 1; i < selectedPhrases.length; i++) {
                setTimeout(() => {
                    const additionalMessage = {
                        id: this.dataManager.generateMessageId(),
                        text: selectedPhrases[i],
                        sender: 'other',
                        time: this.getCurrentTime(),
                        read: true,
                        isTarot: true
                    };
                    
                    this.appData.messages.push(additionalMessage);
                    this.renderMessages();
                }, (i * 1000) + Math.random() * 500);
            }
        }
        
        const notificationText = source === 'auto' ? 
            `å¯¹æ–¹ä¸»åŠ¨æŠ½å–äº†${selectedPhrases.length}å¼ å¡”ç½—ç‰Œ ğŸ”®` : 
            `å¯¹æ–¹å›å¤äº†${selectedPhrases.length}å¼ å¡”ç½—ç‰Œ ğŸ”®`;
        
        this.showNotification(notificationText);
        this.saveAllData();
    }
    
    autoSendMessage() {
        this.appData.isTyping = true;
        this.renderMessages();
        
        setTimeout(() => {
            this.appData.isTyping = false;
            
            if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                this.generateTarotReply('auto');
            } else {
                const messageCount = Math.floor(Math.random() * 3) + 1;
                const totalRatio = (this.appData.sendSettings?.stickerRatio || 50) + (this.appData.sendSettings?.phraseRatio || 50);
                const stickerProbability = (this.appData.sendSettings?.stickerRatio || 50) / totalRatio;
                
                const messagesToSend = [];
                
                for (let i = 0; i < messageCount; i++) {
                    const isSticker = Math.random() < stickerProbability && this.appData.stickers?.length > 0;
                    
                    if (isSticker) {
                        const randomSticker = this.appData.stickers[Math.floor(Math.random() * this.appData.stickers.length)];
                        messagesToSend.push({ type: 'sticker', data: randomSticker.data });
                    } else {
                        const randomPhrase = this.appData.responsePhrases[Math.floor(Math.random() * this.appData.responsePhrases.length)];
                        messagesToSend.push({ type: 'text', data: randomPhrase });
                    }
                }
                
                const firstMsg = messagesToSend[0];
                const firstMessage = {
                    id: this.dataManager.generateMessageId(),
                    isSticker: firstMsg.type === 'sticker',
                    [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
                    sender: 'other',
                    time: this.getCurrentTime(),
                    read: true
                };
                
                if (Math.random() < 0.2) {
                    const recentUserMessages = this.appData.messages
                        .filter(msg => msg.sender === 'self')
                        .slice(-3);
                    
                    if (recentUserMessages.length > 0) {
                        const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
                        firstMessage.quotedMessage = {
                            id: randomUserMessage.id,
                            text: randomUserMessage.text || '',
                            isSticker: randomUserMessage.isSticker || false,
                            stickerData: randomUserMessage.stickerData || null,
                            sender: randomUserMessage.sender,
                            time: randomUserMessage.time
                        };
                    }
                }
                
                this.appData.messages.push(firstMessage);
                this.renderMessages();
                
                if (messagesToSend.length > 1) {
                    for (let i = 1; i < messagesToSend.length; i++) {
                        setTimeout(() => {
                            const msg = messagesToSend[i];
                            const additionalMessage = {
                                id: this.dataManager.generateMessageId(),
                                isSticker: msg.type === 'sticker',
                                [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
                                sender: 'other',
                                time: this.getCurrentTime(),
                                read: true
                            };
                            
                            this.appData.messages.push(additionalMessage);
                            this.renderMessages();
                        }, (i * 800) + Math.random() * 500);
                    }
                }
                
                this.showNotification('å¯¹æ–¹ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯');
                this.saveAllData();
            }
        }, 1000 + Math.random() * 2000);
    }
    
    quoteMessage(message) {
        if (!message) return;
        
        this.appData.quotedMessage = {
            id: message.id,
            text: message.text || '',
            isSticker: message.isSticker || false,
            stickerData: message.stickerData || null,
            sender: message.sender,
            time: message.time
        };
        
        let quoteText = '';
        if (message.isSticker) {
            quoteText = '[è¡¨æƒ…åŒ…]';
        } else if (message.text) {
            quoteText = message.text.length > 30 ? message.text.substring(0, 30) + '...' : message.text;
        }
        
        const input = document.getElementById('messageInput');
        if (input) {
            input.placeholder = `å›å¤ "${quoteText}"...`;
            input.focus();
        }
        
        this.showNotification('å·²å¼•ç”¨æ¶ˆæ¯ï¼Œè¾“å…¥å›å¤å†…å®¹åå‘é€');
    }
    
    deleteMessage(messageId) {
        if (!messageId) return;
        
        const initialLength = this.appData.messages.length;
        this.appData.messages = this.appData.messages.filter(msg => msg.id !== messageId);
        
        if (this.appData.readNoReplyMessageIds) {
            const index = this.appData.readNoReplyMessageIds.indexOf(messageId);
            if (index > -1) this.appData.readNoReplyMessageIds.splice(index, 1);
        }
        
        if (this.appData.messages.length < initialLength) {
            this.renderMessages();
            this.saveAllData();
            this.showNotification('æ¶ˆæ¯å·²åˆ é™¤');
        }
    }
    
    recallMessage(messageId) {
        if (!messageId) return;
        
        const messageIndex = this.appData.messages.findIndex(msg => msg.id === messageId);
        if (messageIndex === -1) return;
        
        const message = this.appData.messages[messageIndex];
        
        if (message.sender !== 'self') {
            this.showNotification('åªèƒ½æ’¤å›è‡ªå·±å‘é€çš„æ¶ˆæ¯');
            return;
        }
        
        this.appData.messages[messageIndex].recalled = true;
        this.appData.messages[messageIndex].text = '[å·²æ’¤å›]';
        this.appData.messages[messageIndex].isSticker = false;
        this.appData.messages[messageIndex].stickerData = null;
        
        this.renderMessages();
        this.saveAllData();
        this.showNotification('æ¶ˆæ¯å·²æ’¤å›');
    }
    
    // ========================
    // è®¾ç½®æ“ä½œ
    // ========================
    
    selectTarotNumber(number) {
        if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        this.appData.tarotSettings.drawCount = number;
        
        const tarotCountValue = document.getElementById('tarotCountValue');
        if (tarotCountValue) tarotCountValue.textContent = number;
        
        document.querySelectorAll('.tarot-number').forEach(el => {
            el.classList.remove('active');
            if (parseInt(el.dataset.number) === number) {
                el.classList.add('active');
            }
        });
        
        this.saveAllData();
        this.showNotification(`å¡”ç½—ç‰ŒæŠ½å–æ•°é‡è®¾ç½®ä¸º: ${number}`);
    }
    
    saveTarotSettings() {
        const textarea = document.getElementById('tarotTextarea');
        if (!textarea) return;
        
        const text = textarea.value.trim();
        const phrases = text.split('\n')
            .map(p => p.trim())
            .filter(p => p.length > 0);
        
        if (!this.appData.tarotSettings) {
            this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        }
        
        this.appData.tarotSettings.customPhrases = phrases;
        
        // é‡ç½®å·²æŠ½å–è®°å½•
        this.appData.drawnCards = new Set();
        
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
        
        if (phrases.length === 0) {
            this.showNotification('å·²æ¸…ç©ºè‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡');
        } else {
            this.showNotification(`å·²ä¿å­˜ ${phrases.length} å¼ è‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡`);
        }
        
        this.saveAllData();
        this.closeSettingsPanel();
    }
    
    loadDefaultTarotCards() {
        if (!this.appData.tarotSettings) {
            this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        }
        
        this.appData.tarotSettings.customPhrases = [...this.DEFAULT_TAROT_CARDS];
        
        const textarea = document.getElementById('tarotTextarea');
        if (textarea) textarea.value = this.DEFAULT_TAROT_CARDS.join('\n');
        
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
        this.showNotification('å·²åŠ è½½78å¼ é»˜è®¤å¡”ç½—ç‰Œ');
        
        this.appData.drawnCards = new Set();
        this.saveAllData();
    }
    
    clearTarotCards() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¡”ç½—ç‰Œå­—å¡å—ï¼Ÿ')) {
            if (!this.appData.tarotSettings) {
                this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
            }
            
            this.appData.tarotSettings.customPhrases = [];
            
            const textarea = document.getElementById('tarotTextarea');
            if (textarea) textarea.value = '';
            
            this.updateTarotPhraseCount();
            this.updateTarotStatus();
            this.showNotification('å·²æ¸…ç©ºå¡”ç½—ç‰Œå­—å¡');
            
            this.appData.drawnCards = new Set();
            this.saveAllData();
        }
    }
    
    savePhrases() {
        const textarea = document.getElementById('phrasesTextarea');
        if (!textarea) return;
        
        const text = textarea.value.trim();
        if (!text) {
            this.showNotification('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè¯æ¡');
            return;
        }
        
        const phrases = text.split('\n')
            .map(p => p.trim())
            .filter(p => p.length > 0);
        
        if (phrases.length === 0) {
            this.showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è¯æ¡');
            return;
        }
        
        this.appData.responsePhrases = phrases;
        this.updatePhraseCount();
        this.saveAllData();
        this.showNotification(`å·²ä¿å­˜ ${phrases.length} ä¸ªè¯æ¡`);
        this.closeSettingsPanel();
    }
    
    saveAppearanceSettings() {
        const appTitleInput = document.getElementById('appTitleInput');
        const appSubtitleInput = document.getElementById('appSubtitleInput');
        const loveYear = document.getElementById('loveYear');
        const loveMonth = document.getElementById('loveMonth');
        const loveDay = document.getElementById('loveDay');
        const moodChangeFrequency = document.getElementById('moodChangeFrequency');
        
        if (!this.appData.appearanceSettings) {
            this.appData.appearanceSettings = {
                appTitle: 'æ¢¦è§’çˆ±äºº',
                appSubtitle: 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´',
                loveStartDate: new Date(2024, 0, 1),
                moodChangeFrequency: 600000
            };
        }
        
        if (appTitleInput) this.appData.appearanceSettings.appTitle = appTitleInput.value || 'æ¢¦è§’çˆ±äºº';
        if (appSubtitleInput) this.appData.appearanceSettings.appSubtitle = appSubtitleInput.value || 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´';
        
        if (loveYear && loveMonth && loveDay) {
            const year = parseInt(loveYear.value) || 2024;
            const month = parseInt(loveMonth.value) - 1 || 0;
            const day = parseInt(loveDay.value) || 1;
            this.appData.appearanceSettings.loveStartDate = new Date(year, month, day);
        }
        
        if (moodChangeFrequency) {
            this.appData.appearanceSettings.moodChangeFrequency = parseInt(moodChangeFrequency.value) || 600000;
        }
        
        clearInterval(this.appData.moodTimer);
        this.startMoodChanging();
        
        this.calculateLoveDays();
        this.renderAppearance();
        this.saveAllData();
        this.showNotification('å¤–è§‚è®¾ç½®å·²ä¿å­˜');
        this.closeSettingsPanel();
    }
    
    saveBackgroundSettings() {
        const slider = document.getElementById('backgroundOpacitySlider');
        if (slider && this.appData.backgroundSettings) {
            this.appData.backgroundSettings.opacity = parseInt(slider.value);
        }
        
        this.saveAllData();
        this.showNotification('èƒŒæ™¯è®¾ç½®å·²ä¿å­˜');
        this.closeSettingsPanel();
    }
    
    saveCommunicationSettings() {
        const autoAcceptCalls = document.getElementById('autoAcceptCalls');
        const autoAcceptVideos = document.getElementById('autoAcceptVideos');
        
        if (!this.appData.communicationSettings) {
            this.appData.communicationSettings = {
                autoAcceptCalls: true,
                autoAcceptVideos: true,
                todayCalls: 0,
                todayVideos: 0,
                totalCallTime: 0,
                totalVideoTime: 0,
                todayIncomingCalls: 0,
                activeCallSettings: {
                    enabled: true,
                    overallFrequency: 30,
                    callPreference: 50,
                    presetMode: 'custom',
                    minInterval: 15,
                    maxInterval: 45,
                    respectBusyStatus: true,
                    timeSensitivity: true,
                    adaptToActivity: true
                }
            };
        }
        
        if (autoAcceptCalls) this.appData.communicationSettings.autoAcceptCalls = autoAcceptCalls.checked;
        if (autoAcceptVideos) this.appData.communicationSettings.autoAcceptVideos = autoAcceptVideos.checked;
        
        this.saveAllData();
        this.showNotification('é€šè¯è®¾ç½®å·²ä¿å­˜');
        this.closeSettingsPanel();
    }
    
    // ========================
    // UIæ“ä½œ
    // ========================
    
    openSettings() {
        const panel = document.getElementById('settingsPanel');
        const overlay = document.getElementById('settingsOverlay');
        
        if (panel) panel.classList.add('active');
        if (overlay) overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    closeSettingsPanel() {
        const panel = document.getElementById('settingsPanel');
        const overlay = document.getElementById('settingsOverlay');
        
        if (panel) panel.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    switchTab(tabId) {
        if (!document.getElementById('settingsPanel')?.classList.contains('active')) {
            this.openSettings();
        }
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
        });
        
        tabContents.forEach(content => {
            content.classList.toggle('active', content.id === `${tabId}Tab`);
        });
    }
    
    // ========================
    // é€šè¯åŠŸèƒ½
    // ========================
    
    createCallWindow(type) {
        const existing = document.querySelector('.call-window');
        if (existing) existing.remove();
        
        const callWindow = document.createElement('div');
        callWindow.className = 'call-window';
        callWindow.style.left = '50px';
        callWindow.style.top = '50px';
        
        const avatarContent = this.appData.otherInfo?.avatar ? 
            `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : 
            `<span></span>`;
        
        callWindow.innerHTML = `
            <div class="window-header">
                <div class="window-title">
                    <i class="material-icons">call</i>
                    <span>è¯­éŸ³é€šè¯</span>
                </div>
                <div class="window-controls">
                    <button class="window-btn" id="minimizeCall">âˆ’</button>
                    <button class="window-btn" id="closeCall">Ã—</button>
                </div>
            </div>
            <div class="window-content">
                <div class="call-avatar">
                    ${avatarContent}
                </div>
                <div class="calling-text">${type === 'outgoing' ? 'ç­‰å¾…å¯¹æ–¹æ¥å¬...' : 'å¯¹æ–¹æ¥ç”µ...'}</div>
                ${type === 'incoming' ? `
                    <div class="call-buttons">
                        <button class="accept-btn" id="acceptCall">
                            <i class="material-icons">call</i>
                            æ¥å¬
                        </button>
                        <button class="reject-btn" id="rejectCall">
                            <i class="material-icons">call_end</i>
                            æ‹’ç»
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
        
        document.body.appendChild(callWindow);
        this.appData.activeCall = callWindow;
        
        this.makeWindowDraggable(callWindow);
        
        if (type === 'incoming') {
            callWindow.querySelector('#acceptCall')?.addEventListener('click', () => this.answerCall());
            callWindow.querySelector('#rejectCall')?.addEventListener('click', () => this.rejectCall());
        }
        
        callWindow.querySelector('#closeCall')?.addEventListener('click', () => this.endCall());
        callWindow.querySelector('#minimizeCall')?.addEventListener('click', () => {
            callWindow.style.display = callWindow.style.display === 'none' ? 'flex' : 'none';
        });
        
        if (type === 'incoming' && this.appData.communicationSettings?.autoAcceptCalls) {
            setTimeout(() => {
                if (this.appData.activeCall === callWindow) this.answerCall();
            }, 2000);
        }
    }
    
    createVideoWindow(type) {
        const existing = document.querySelector('.video-window');
        if (existing) existing.remove();
        
        const videoWindow = document.createElement('div');
        videoWindow.className = 'video-window';
        videoWindow.style.left = '100px';
        videoWindow.style.top = '100px';
        
        const avatarContent = this.appData.otherInfo?.avatar ? 
            `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : 
            `<span></span>`;
        
        videoWindow.innerHTML = `
            <div class="window-header">
                <div class="window-title">
                    <i class="material-icons">videocam</i>
                    <span>è§†é¢‘é€šè¯</span>
                </div>
                <div class="window-controls">
                    <button class="window-btn" id="minimizeVideo">âˆ’</button>
                    <button class="window-btn" id="closeVideo">Ã—</button>
                </div>
            </div>
            <div class="window-content">
                <div class="video-avatar">
                    ${avatarContent}
                </div>
                <div class="calling-text">${type === 'outgoing' ? 'ç­‰å¾…å¯¹æ–¹æ¥å¬...' : 'å¯¹æ–¹è§†é¢‘é‚€è¯·...'}</div>
                ${type === 'incoming' ? `
                    <div class="call-buttons">
                        <button class="accept-btn" id="acceptVideo">
                            <i class="material-icons">videocam</i>
                            æ¥å¬
                        </button>
                        <button class="reject-btn" id="rejectVideo">
                            <i class="material-icons">call_end</i>
                            æ‹’ç»
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
        
        document.body.appendChild(videoWindow);
        this.appData.activeVideo = videoWindow;
        
        this.makeWindowDraggable(videoWindow);
        
        if (type === 'incoming') {
            videoWindow.querySelector('#acceptVideo')?.addEventListener('click', () => this.answerVideo());
            videoWindow.querySelector('#rejectVideo')?.addEventListener('click', () => this.rejectVideo());
        }
        
        videoWindow.querySelector('#closeVideo')?.addEventListener('click', () => this.endVideo());
        videoWindow.querySelector('#minimizeVideo')?.addEventListener('click', () => {
            videoWindow.style.display = videoWindow.style.display === 'none' ? 'flex' : 'none';
        });
        
        if (type === 'incoming' && this.appData.communicationSettings?.autoAcceptVideos) {
            setTimeout(() => {
                if (this.appData.activeVideo === videoWindow) this.answerVideo();
            }, 2000);
        }
    }
    
    makeWindowDraggable(windowElement) {
        let isDragging = false;
        let offsetX, offsetY;
        
        const header = windowElement.querySelector('.window-header');
        
        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = windowElement.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            windowElement.classList.add('active');
            windowElement.style.transition = 'none';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            
            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            windowElement.style.left = `${x}px`;
            windowElement.style.top = `${y}px`;
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            windowElement.classList.remove('active');
            windowElement.style.transition = '';
        });
        
        header.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            isDragging = true;
            const rect = windowElement.getBoundingClientRect();
            offsetX = touch.clientX - rect.left;
            offsetY = touch.clientY - rect.top;
            windowElement.classList.add('active');
            windowElement.style.transition = 'none';
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            
            let x = touch.clientX - offsetX;
            let y = touch.clientY - offsetY;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            windowElement.style.left = `${x}px`;
            windowElement.style.top = `${y}px`;
        }, { passive: false });
        
        document.addEventListener('touchend', () => {
            isDragging = false;
            windowElement.classList.remove('active');
            windowElement.style.transition = '';
        });
        
        document.addEventListener('touchcancel', () => {
            isDragging = false;
            windowElement.classList.remove('active');
            windowElement.style.transition = '';
        });
    }
    
    answerCall() {
        if (!this.appData.activeCall) return;
        
        const content = this.appData.activeCall.querySelector('.window-content');
        if (!content) return;
        
        content.innerHTML = `
            <div class="call-avatar">
                ${this.appData.otherInfo?.avatar ? 
                  `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : 
                  `<span></span>`}
            </div>
            <div class="in-call-text">æ­£åœ¨é€šè¯ä¸­...</div>
            <div class="call-timer" id="callTimer">00:00</div>
            <div class="call-buttons">
                <button class="end-btn" id="endCall">
                    <i class="material-icons">call_end</i>
                    æŒ‚æ–­
                </button>
            </div>
        `;
        
        content.querySelector('#endCall')?.addEventListener('click', () => this.endCall());
        
        this.appData.callStartTime = new Date();
        this.startCallTimer();
    }
    
    answerVideo() {
        if (!this.appData.activeVideo) return;
        
        const content = this.appData.activeVideo.querySelector('.window-content');
        if (!content) return;
        
        content.innerHTML = `
            <div class="video-avatar">
                ${this.appData.otherInfo?.avatar ? 
                  `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : 
                  `<span></span>`}
            </div>
            <div class="in-call-text">æ­£åœ¨è§†é¢‘é€šè¯ä¸­...</div>
            <div class="call-timer" id="videoTimer">00:00</div>
            <div class="call-buttons">
                <button class="end-btn" id="endVideo">
                    <i class="material-icons">call_end</i>
                    æŒ‚æ–­
                </button>
            </div>
        `;
        
        content.querySelector('#endVideo')?.addEventListener('click', () => this.endVideo());
        
        this.appData.callStartTime = new Date();
        this.startCallTimer();
    }
    
    rejectCall() {
        if (!this.appData.activeCall) return;
        
        const callMessage = {
            id: this.dataManager.generateMessageId(),
            type: 'call',
            title: 'å·²æ‹’ç»è¯­éŸ³é€šè¯',
            sender: 'other',
            time: this.getCurrentTime(),
            read: true
        };
        
        this.appData.messages.push(callMessage);
        this.renderMessages();
        
        this.appData.activeCall.remove();
        this.appData.activeCall = null;
        this.showNotification('å·²æ‹’ç»é€šè¯');
        this.saveAllData();
    }
    
    rejectVideo() {
        if (!this.appData.activeVideo) return;
        
        const videoMessage = {
            id: this.dataManager.generateMessageId(),
            type: 'video',
            title: 'å·²æ‹’ç»è§†é¢‘é€šè¯',
            sender: 'other',
            time: this.getCurrentTime(),
            read: true
        };
        
        this.appData.messages.push(videoMessage);
        this.renderMessages();
        
        this.appData.activeVideo.remove();
        this.appData.activeVideo = null;
        this.showNotification('å·²æ‹’ç»è§†é¢‘é€šè¯');
        this.saveAllData();
    }
    
    endCall() {
        if (!this.appData.activeCall) return;
        
        const endTime = new Date();
        const durationMs = endTime - this.appData.callStartTime;
        const durationSec = Math.floor(durationMs / 1000);
        const minutes = Math.floor(durationSec / 60);
        const seconds = durationSec % 60;
        const durationText = `${minutes}åˆ†${seconds}ç§’`;
        
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.totalCallTime = (this.appData.communicationSettings.totalCallTime || 0) + minutes;
        }
        
        const callMessage = {
            id: this.dataManager.generateMessageId(),
            type: 'call',
            title: 'è¯­éŸ³é€šè¯',
            duration: durationText,
            sender: 'self',
            time: this.getCurrentTime(),
            read: true
        };
        
        this.appData.messages.push(callMessage);
        this.renderMessages();
        
        this.appData.activeCall.remove();
        this.appData.activeCall = null;
        
        clearInterval(this.appData.callTimer);
        
        this.showNotification(`é€šè¯ç»“æŸï¼Œæ—¶é•¿: ${durationText}`);
        this.renderCommunicationStats();
        this.saveAllData();
    }
    
    endVideo() {
        if (!this.appData.activeVideo) return;
        
        const endTime = new Date();
        const durationMs = endTime - this.appData.callStartTime;
        const durationSec = Math.floor(durationMs / 1000);
        const minutes = Math.floor(durationSec / 60);
        const seconds = durationSec % 60;
        const durationText = `${minutes}åˆ†${seconds}ç§’`;
        
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.totalVideoTime = (this.appData.communicationSettings.totalVideoTime || 0) + minutes;
        }
        
        const videoMessage = {
            id: this.dataManager.generateMessageId(),
            type: 'video',
            title: 'è§†é¢‘é€šè¯',
            duration: durationText,
            sender: 'self',
            time: this.getCurrentTime(),
            read: true
        };
        
        this.appData.messages.push(videoMessage);
        this.renderMessages();
        
        this.appData.activeVideo.remove();
        this.appData.activeVideo = null;
        
        clearInterval(this.appData.callTimer);
        
        this.showNotification(`è§†é¢‘é€šè¯ç»“æŸï¼Œæ—¶é•¿: ${durationText}`);
        this.renderCommunicationStats();
        this.saveAllData();
    }
    
    startCall() {
        if (this.appData.activeCall) {
            this.showNotification('å½“å‰å·²æœ‰é€šè¯è¿›è¡Œä¸­');
            return;
        }
        
        this.createCallWindow('outgoing');
        
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayCalls = (this.appData.communicationSettings.todayCalls || 0) + 1;
            this.renderCommunicationStats();
            this.saveAllData();
        }
        
        setTimeout(() => {
            if (this.appData.activeCall) this.answerCall();
        }, 5000 + Math.random() * 5000);
    }
    
    startVideo() {
        if (this.appData.activeVideo) {
            this.showNotification('å½“å‰å·²æœ‰è§†é¢‘é€šè¯è¿›è¡Œä¸­');
            return;
        }
        
        this.createVideoWindow('outgoing');
        
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayVideos = (this.appData.communicationSettings.todayVideos || 0) + 1;
            this.renderCommunicationStats();
            this.saveAllData();
        }
        
        setTimeout(() => {
            if (this.appData.activeVideo) this.answerVideo();
        }, 5000 + Math.random() * 5000);
    }
    
    startCallTimer() {
        clearInterval(this.appData.callTimer);
        
        let seconds = 0;
        this.appData.callTimer = setInterval(() => {
            seconds++;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timerText = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            const callTimer = document.getElementById('callTimer');
            const videoTimer = document.getElementById('videoTimer');
            
            if (callTimer) callTimer.textContent = timerText;
            if (videoTimer) videoTimer.textContent = timerText;
        }, 1000);
    }
    
    // ========================
    // å›¾ç‰‡å¤„ç†
    // ========================
    
    handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        this.compressImage(file, { maxWidth: 300, maxHeight: 300, quality: 0.7 })
            .then(compressedDataUrl => {
                const imageMessage = {
                    id: this.dataManager.generateMessageId(),
                    isSticker: true,
                    stickerData: compressedDataUrl,
                    sender: 'self',
                    time: this.getCurrentTime(),
                    read: false,
                    quotedMessage: this.appData.quotedMessage ? {...this.appData.quotedMessage} : null
                };
                
                this.appData.messages.push(imageMessage);
                this.renderMessages();
                
                this.appData.quotedMessage = null;
                const input = document.getElementById('messageInput');
                if (input) input.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                
                this.saveAllData();
                
                const willReply = Math.random() > 0.3;
                if (willReply) {
                    this.appData.waitingForReply = true;
                    this.startTypingIndicator();
                    
                    setTimeout(() => {
                        if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                            this.generateTarotReply('reply');
                        } else {
                            this.generateReply(imageMessage.id);
                        }
                    }, 1500 + Math.random() * 2000);
                } else {
                    this.appData.waitingForReply = false;
                    
                    setTimeout(() => {
                        this.markSelfMessagesAsRead();
                        
                        if (imageMessage.id) {
                            if (!this.appData.readNoReplyMessageIds) this.appData.readNoReplyMessageIds = [];
                            this.appData.readNoReplyMessageIds.push(imageMessage.id);
                        }
                        
                        this.renderMessages();
                        this.showNotification('å¯¹æ–¹å·²è¯»ä¸å›');
                        this.saveAllData();
                    }, 1000 + Math.random() * 3000);
                }
            });
        
        e.target.value = '';
    }
    
    handleStickerUpload(e) {
        const files = e.target.files;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            this.compressImage(file, { maxWidth: 200, maxHeight: 200, quality: 0.6 })
                .then(compressedDataUrl => {
                    const stickerData = {
                        id: Date.now() + i,
                        data: compressedDataUrl,
                        name: file.name
                    };
                    
                    if (!this.appData.stickers) this.appData.stickers = [];
                    this.appData.stickers.push(stickerData);
                    
                    this.renderStickerPreview();
                    this.saveAllData();
                    this.showNotification(`å·²æ·»åŠ è¡¨æƒ…åŒ…: ${file.name}`);
                });
        }
        
        e.target.value = '';
    }
    
    handleBackgroundUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // ç›´æ¥è¯»å–åŸå›¾ï¼Œä¸å‹ç¼©
  const reader = new FileReader();
  reader.onload = (e) => {
    if (!this.appData.backgroundSettings) {
      this.appData.backgroundSettings = { backgroundImage: null, opacity: 100 };
    }
    
    this.appData.backgroundSettings.backgroundImage = e.target.result;
    
    this.updateBackgroundPreview();
    this.applyBackgroundSettings();
    this.saveAllData();
    this.showNotification('èƒŒæ™¯å›¾ç‰‡å·²ä¸Šä¼ ');
  };
  reader.readAsDataURL(file);
  
  e.target.value = '';
}
    
    compressImage(file, options) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > options.maxWidth) {
                            height = Math.round(height * options.maxWidth / width);
                            width = options.maxWidth;
                        }
                    } else {
                        if (height > options.maxHeight) {
                            width = Math.round(width * options.maxHeight / height);
                            height = options.maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', options.quality);
                    resolve(compressedDataUrl);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    
    removeBackground() {
        if (this.appData.backgroundSettings) {
            this.appData.backgroundSettings.backgroundImage = null;
            this.appData.backgroundSettings.opacity = 100;
        }
        
        const slider = document.getElementById('backgroundOpacitySlider');
        const value = document.getElementById('backgroundOpacityValue');
        
        if (slider) slider.value = 100;
        if (value) value.textContent = '100%';
        
        this.updateBackgroundPreview();
        this.applyBackgroundSettings();
        this.saveAllData();
        this.showNotification('å·²æ¢å¤é»˜è®¤èƒŒæ™¯');
    }
    
    // ========================
    // ç”¨æˆ·ä¿¡æ¯ç¼–è¾‘
    // ========================
    
    openUserEditModal(userType) {
        this.appData.editingUserType = userType;
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) {
            modalTitle.textContent = userType === 'self' ? 'ç¼–è¾‘æˆ‘çš„ä¿¡æ¯' : 'ç¼–è¾‘å¯¹æ–¹ä¿¡æ¯';
        }
        
        const modalNicknameInput = document.getElementById('modalNicknameInput');
        if (modalNicknameInput) {
            modalNicknameInput.value = userInfo?.nickname || '';
        }
        
        const avatarPreview = document.getElementById('avatarPreview');
        if (avatarPreview) {
            avatarPreview.innerHTML = '';
            if (userInfo?.avatar) {
                avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
            } else {
                avatarPreview.innerHTML = `<span></span>`;
            }
        }
        
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    closeUserEditModal() {
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        this.appData.editingUserType = null;
    }
    
    saveUserInfo() {
        const userType = this.appData.editingUserType;
        if (!userType) return;
        
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        if (!userInfo) return;
        
        const modalNicknameInput = document.getElementById('modalNicknameInput');
        if (modalNicknameInput && modalNicknameInput.value.trim()) {
            userInfo.nickname = modalNicknameInput.value.trim();
        }
        
        this.renderUserInfo();
        this.renderMessages();
        this.saveAllData();
        
        this.showNotification(`${userType === 'self' ? 'æˆ‘çš„' : 'å¯¹æ–¹'}ä¿¡æ¯å·²æ›´æ–°`);
        this.closeUserEditModal();
    }
    
    handleAvatarUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const userType = this.appData.editingUserType;
        if (!userType) return;
        
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        if (!userInfo) return;
        
        this.compressImage(file, { maxWidth: 200, maxHeight: 200, quality: 0.7 })
            .then(compressedDataUrl => {
                userInfo.avatar = compressedDataUrl;
                
                const avatarPreview = document.getElementById('avatarPreview');
                if (avatarPreview) {
                    avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
                }
                
                this.showNotification('å¤´åƒå·²æ›´æ–°');
                this.saveAllData();
            });
        
        e.target.value = '';
    }
    
    // ========================
    // ä¸»åŠ¨å‘¼å«è®¾ç½®
    // ========================
    
    updateOverallFrequency() {
        const slider = document.getElementById('overallFrequencySlider');
        if (!slider) return;
        
        const value = parseInt(slider.value);
        
        if (!this.appData.communicationSettings) {
            this.appData.communicationSettings = { activeCallSettings: {} };
        }
        if (!this.appData.communicationSettings.activeCallSettings) {
            this.appData.communicationSettings.activeCallSettings = {};
        }
        
        this.appData.communicationSettings.activeCallSettings.overallFrequency = value;
        this.appData.communicationSettings.activeCallSettings.enabled = value > 0;
        this.appData.communicationSettings.activeCallSettings.presetMode = 'custom';
        
        this.updateOverallFrequencyDisplay();
        this.updatePresetButtons();
        this.updateActiveCallPreview();
        
        this.restartActiveCallScheduler();
        this.saveAllData();
    }
    
    updateCallPreference() {
        const slider = document.getElementById('callPreferenceSlider');
        if (!slider) return;
        
        const value = parseInt(slider.value);
        
        if (!this.appData.communicationSettings) {
            this.appData.communicationSettings = { activeCallSettings: {} };
        }
        if (!this.appData.communicationSettings.activeCallSettings) {
            this.appData.communicationSettings.activeCallSettings = {};
        }
        
        this.appData.communicationSettings.activeCallSettings.callPreference = value;
        this.appData.communicationSettings.activeCallSettings.presetMode = 'custom';
        
        this.updateCallPreferenceDisplay();
        this.updatePresetButtons();
        this.updateActiveCallPreview();
        
        this.saveAllData();
    }
    
    applyPresetMode(preset) {
        if (!this.PRESET_MODES[preset]) return;
        
        const presetConfig = this.PRESET_MODES[preset];
        
        if (!this.appData.communicationSettings) {
            this.appData.communicationSettings = { activeCallSettings: {} };
        }
        if (!this.appData.communicationSettings.activeCallSettings) {
            this.appData.communicationSettings.activeCallSettings = {};
        }
        
        this.appData.communicationSettings.activeCallSettings.overallFrequency = presetConfig.overallFrequency || 30;
        this.appData.communicationSettings.activeCallSettings.callPreference = presetConfig.callPreference || 50;
        this.appData.communicationSettings.activeCallSettings.presetMode = preset;
        
        if (presetConfig.minInterval !== undefined) {
            this.appData.communicationSettings.activeCallSettings.minInterval = presetConfig.minInterval;
        }
        if (presetConfig.maxInterval !== undefined) {
            this.appData.communicationSettings.activeCallSettings.maxInterval = presetConfig.maxInterval;
        }
        
        const freqSlider = document.getElementById('overallFrequencySlider');
        const prefSlider = document.getElementById('callPreferenceSlider');
        
        if (freqSlider) freqSlider.value = this.appData.communicationSettings.activeCallSettings.overallFrequency;
        if (prefSlider) prefSlider.value = this.appData.communicationSettings.activeCallSettings.callPreference;
        
        this.updateOverallFrequencyDisplay();
        this.updateCallPreferenceDisplay();
        this.updatePresetButtons();
        this.updateActiveCallPreview();
        
        this.restartActiveCallScheduler();
        this.showNotification(`å·²åˆ‡æ¢åˆ°${presetConfig.name}`);
        this.saveAllData();
    }
    
    restartActiveCallScheduler() {
        if (this.appData.activeCallTimer) {
            clearInterval(this.appData.activeCallTimer);
        }
        this.startActiveCallScheduler();
    }
    
    // ========================
    // äº‘å¯¼å…¥å¯¼å‡º
    // ========================
    
    importCloudData() {
        const textarea = document.getElementById('cloudImportTextarea');
        if (!textarea) return;
        
        const jsonText = textarea.value.trim();
        if (!jsonText) {
            this.showNotification('è¯·è¾“å…¥è¦å¯¼å…¥çš„JSONæ•°æ®');
            return;
        }
        
        try {
            const importedData = JSON.parse(jsonText);
            
            if (!importedData.appData && !importedData.messages) {
                this.showNotification('æ•°æ®æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æœ‰æ•ˆçš„å¯¼å‡ºæ•°æ®');
                return;
            }
            
            if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (importedData.appData) {
                    // å®Œæ•´å¯¼å‡ºæ ¼å¼
                    if (importedData.appData.selfInfo) this.appData.selfInfo = importedData.appData.selfInfo;
                    if (importedData.appData.otherInfo) this.appData.otherInfo = importedData.appData.otherInfo;
                    if (importedData.appData.messages) this.appData.messages = importedData.appData.messages;
                    if (importedData.appData.responsePhrases) this.appData.responsePhrases = importedData.appData.responsePhrases;
                    if (importedData.appData.stickers) this.appData.stickers = importedData.appData.stickers;
                    if (importedData.appData.sendSettings) this.appData.sendSettings = importedData.appData.sendSettings;
                    if (importedData.appData.appearanceSettings) {
                        this.appData.appearanceSettings = importedData.appData.appearanceSettings;
                        if (this.appData.appearanceSettings.loveStartDate) {
                            this.appData.appearanceSettings.loveStartDate = new Date(this.appData.appearanceSettings.loveStartDate);
                        }
                    }
                    if (importedData.appData.backgroundSettings) this.appData.backgroundSettings = importedData.appData.backgroundSettings;
                    if (importedData.appData.tarotSettings) this.appData.tarotSettings = importedData.appData.tarotSettings;
                    if (importedData.appData.communicationSettings) this.appData.communicationSettings = importedData.appData.communicationSettings;
                    if (importedData.appData.loveDays) this.appData.loveDays = importedData.appData.loveDays;
                    if (importedData.appData.readNoReplyMessageIds) this.appData.readNoReplyMessageIds = importedData.appData.readNoReplyMessageIds;
                    if (importedData.appData.drawnCards && Array.isArray(importedData.appData.drawnCards)) {
                        this.appData.drawnCards = new Set(importedData.appData.drawnCards);
                    }
                } else {
                    // ç®€å•å¯¼å‡ºæ ¼å¼
                    if (importedData.messages) this.appData.messages = importedData.messages;
                    if (importedData.phrases) this.appData.responsePhrases = importedData.phrases;
                    if (importedData.stickers) this.appData.stickers = importedData.stickers;
                    if (importedData.settings) this.appData.sendSettings = importedData.settings.sendSettings;
                    if (importedData.appearanceSettings) this.appData.appearanceSettings = importedData.appearanceSettings;
                    if (importedData.tarotSettings) this.appData.tarotSettings = importedData.tarotSettings;
                }
                
                this.renderAllUI();
                this.saveAllData();
                this.showNotification('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                textarea.value = '';
                this.closeSettingsPanel();
            }
        } catch (error) {
            console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
            this.showNotification('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯');
        }
    }
    
    clearCloudTextarea() {
        const textarea = document.getElementById('cloudImportTextarea');
        if (textarea) {
            textarea.value = '';
            this.showNotification('å·²æ¸…ç©ºè¾“å…¥æ¡†');
        }
    }
    
    handleCloudFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const textarea = document.getElementById('cloudImportTextarea');
            if (textarea) {
                textarea.value = event.target.result;
                this.showNotification('æ–‡ä»¶å·²åŠ è½½åˆ°è¾“å…¥æ¡†ï¼Œç‚¹å‡»å¯¼å…¥æŒ‰é’®å®Œæˆå¯¼å…¥');
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    }
    
    exportChatHistory(format) {
        const includeMessages = document.getElementById('exportMessages')?.checked ?? true;
        const includeSettings = document.getElementById('exportSettings')?.checked ?? true;
        const includeStickers = document.getElementById('exportStickers')?.checked ?? true;
        const includePhrases = document.getElementById('exportPhrases')?.checked ?? true;
        const includeTarot = document.getElementById('exportTarot')?.checked ?? true;
        const includeBackground = document.getElementById('exportBackground')?.checked ?? true;
        const includeCommunication = document.getElementById('exportCommunication')?.checked ?? true;
        
        const exportData = {};
        
        if (includeMessages) {
            exportData.messages = this.appData.messages;
        }
        
        if (includeSettings) {
            exportData.settings = {
                sendSettings: this.appData.sendSettings,
                appearanceSettings: this.appData.appearanceSettings
            };
        }
        
        if (includeStickers) {
            exportData.stickers = this.appData.stickers;
        }
        
        if (includePhrases) {
            exportData.phrases = this.appData.responsePhrases;
        }
        
        if (includeTarot) {
            exportData.tarotSettings = {
                enabled: this.appData.tarotSettings?.enabled,
                drawCount: this.appData.tarotSettings?.drawCount,
                customPhrases: this.appData.tarotSettings?.customPhrases,
                count: this.appData.tarotSettings?.customPhrases?.length || 0
            };
        }
        
        if (includeBackground) {
            exportData.background = {
                backgroundImage: this.appData.backgroundSettings?.backgroundImage,
                opacity: this.appData.backgroundSettings?.opacity
            };
        }
        
        if (includeCommunication) {
            exportData.communicationStats = {
                todayCalls: this.appData.communicationSettings?.todayCalls,
                todayVideos: this.appData.communicationSettings?.todayVideos,
                totalCallTime: this.appData.communicationSettings?.totalCallTime,
                totalVideoTime: this.appData.communicationSettings?.totalVideoTime,
                todayIncomingCalls: this.appData.communicationSettings?.todayIncomingCalls,
                activeCallSettings: this.appData.communicationSettings?.activeCallSettings
            };
        }
        
        exportData.exportTime = new Date().toISOString();
        exportData.appName = this.appData.appearanceSettings?.appTitle || 'æ¢¦è§’çˆ±äºº';
        exportData.userInfo = {
            self: this.appData.selfInfo?.nickname || 'æˆ‘',
            other: this.appData.otherInfo?.nickname || 'å¯¹æ–¹'
        };
        
        let content = '';
        let filename = '';
        let mimeType = '';
        
        switch (format) {
            case 'txt':
                content = this.formatAsTxt(exportData);
                filename = `èŠå¤©è®°å½•_${this.getFormattedDate()}.txt`;
                mimeType = 'text/plain';
                break;
            case 'json':
                content = JSON.stringify(exportData, null, 2);
                filename = `èŠå¤©è®°å½•_${this.getFormattedDate()}.json`;
                mimeType = 'application/json';
                break;
            case 'html':
                content = this.formatAsHtml(exportData);
                filename = `èŠå¤©è®°å½•_${this.getFormattedDate()}.html`;
                mimeType = 'text/html';
                break;
        }
        
        this.downloadFile(content, filename, mimeType);
        this.showNotification(`èŠå¤©è®°å½•å·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`);
    }
    
    exportAllData() {
        const exportData = {
            appData: {
                selfInfo: this.appData.selfInfo,
                otherInfo: this.appData.otherInfo,
                sendSettings: this.appData.sendSettings,
                appearanceSettings: this.appData.appearanceSettings,
                backgroundSettings: this.appData.backgroundSettings,
                tarotSettings: this.appData.tarotSettings,
                communicationSettings: this.appData.communicationSettings,
                responsePhrases: this.appData.responsePhrases,
                messages: this.appData.messages,
                stickers: this.appData.stickers,
                loveDays: this.appData.loveDays,
                readNoReplyMessageIds: this.appData.readNoReplyMessageIds,
                drawnCards: Array.from(this.appData.drawnCards || []),
                todayDate: this.appData.todayDate
            },
            exportTime: new Date().toISOString(),
            exportVersion: '2.0'
        };
        
        const content = JSON.stringify(exportData, null, 2);
        const filename = `æ¢¦è§’çˆ±äººå®Œæ•´å¤‡ä»½_${this.getFormattedDate()}.json`;
        
        this.downloadFile(content, filename, 'application/json');
        this.showNotification('å®Œæ•´æ•°æ®å¤‡ä»½å·²å¯¼å‡º');
    }
    
    formatAsTxt(data) {
        let txt = `${data.appName || 'æ¢¦è§’çˆ±äºº'}èŠå¤©è®°å½•å¯¼å‡º\n`;
        txt += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
        txt += `ç”¨æˆ·: ${data.userInfo?.self || 'æˆ‘'} ä¸ ${data.userInfo?.other || 'å¯¹æ–¹'}\n`;
        txt += `========================================\n\n`;
        
        if (data.messages) {
            txt += `èŠå¤©è®°å½• (å…±${data.messages.length}æ¡):\n`;
            txt += `----------------------------------------\n`;
            
            data.messages.forEach((msg, index) => {
                const sender = msg.sender === 'self' ? (data.userInfo?.self || 'æˆ‘') : (data.userInfo?.other || 'å¯¹æ–¹');
                const status = msg.read ? 'å·²è¯»' : 'æœªè¯»';
                const isReadNoReply = msg.id && this.appData.readNoReplyMessageIds?.includes(msg.id);
                const readNoReplyTag = isReadNoReply ? ' [å·²è¯»ä¸å›]' : '';
                const callTag = msg.type === 'call' ? ' [è¯­éŸ³é€šè¯]' : msg.type === 'video' ? ' [è§†é¢‘é€šè¯]' : '';
                const tarotTag = msg.isTarot ? ' [å¡”ç½—ç‰Œ]' : '';
                
                let content = msg.text || '[è¡¨æƒ…åŒ…]';
                if (msg.type === 'call' || msg.type === 'video') {
                    content = `${msg.title || ''} ${msg.duration || ''}`;
                }
                
                txt += `${index + 1}. [${msg.time}] ${sender}: ${content} (${status}${readNoReplyTag}${callTag}${tarotTag})\n`;
            });
            txt += `\n`;
        }
        
        if (data.phrases) {
            txt += `å›å¤è¯æ¡ (å…±${data.phrases.length}æ¡):\n`;
            txt += `----------------------------------------\n`;
            data.phrases.forEach((phrase, index) => {
                txt += `${index + 1}. ${phrase}\n`;
            });
            txt += `\n`;
        }
        
        if (data.tarotSettings?.customPhrases) {
            txt += `å¡”ç½—ç‰Œå­—å¡ (å…±${data.tarotSettings.customPhrases.length}å¼ ):\n`;
            txt += `----------------------------------------\n`;
            txt += `å¡”ç½—ç‰Œæ¨¡å¼: ${data.tarotSettings.enabled ? 'å¼€å¯' : 'å…³é—­'}\n`;
            txt += `æ¯æ¬¡æŠ½å–æ•°é‡: ${data.tarotSettings.drawCount}å¼ \n`;
            txt += `æ™ºèƒ½è§„åˆ™: åŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–\n`;
            txt += `\n`;
            data.tarotSettings.customPhrases.forEach((phrase, index) => {
                txt += `${index + 1}. ${phrase}\n`;
            });
            txt += `\n`;
        }
        
        return txt;
    }
    
    formatAsHtml(data) {
        let html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${data.appName || 'æ¢¦è§’çˆ±äºº'}èŠå¤©è®°å½•</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
.header { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
.messages { margin-bottom: 30px; }
.message { margin-bottom: 10px; padding: 10px; border-radius: 8px; }
.self { background: #e3f2fd; }
.other { background: #f5f5f5; }
.time { font-size: 0.8em; color: #666; }
.sender { font-weight: bold; }
.call-message { background: rgba(0,0,0,0.1); border-left: 3px solid #000000; }
.video-message { background: rgba(0,0,0,0.1); border-left: 3px solid #000000; }
.tarot-message { background: #f3e5f5; border-left: 3px solid #7b1fa2; }
</style>
</head>
<body>
<div class="header">
<h1>${data.appName || 'æ¢¦è§’çˆ±äºº'}èŠå¤©è®°å½•</h1>
<p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}</p>
<p>ç”¨æˆ·: ${data.userInfo?.self || 'æˆ‘'} ä¸ ${data.userInfo?.other || 'å¯¹æ–¹'}</p>
</div>`;
        
        if (data.messages) {
            html += `<div class="stats">å…± ${data.messages.length} æ¡æ¶ˆæ¯</div>
<div class="messages">`;
            
            data.messages.forEach(msg => {
                const sender = msg.sender === 'self' ? (data.userInfo?.self || 'æˆ‘') : (data.userInfo?.other || 'å¯¹æ–¹');
                const status = msg.read ? 'å·²è¯»' : 'æœªè¯»';
                const messageClass = msg.type === 'call' ? 'call-message' : msg.type === 'video' ? 'video-message' : msg.isTarot ? 'tarot-message' : msg.sender;
                
                let content = msg.text || '[è¡¨æƒ…åŒ…]';
                if (msg.type === 'call' || msg.type === 'video') {
                    content = `<strong>${msg.title || ''}</strong> ${msg.duration || ''}`;
                }
                
                if (msg.isTarot) {
                    content = `ğŸ”® ${content}`;
                }
                
                html += `<div class="message ${messageClass}">
<div class="sender">${sender} <span class="time">${msg.time} (${status})</span></div>
<div>${content}</div>
</div>`;
            });
            
            html += `</div>`;
        }
        
        if (data.phrases) {
            html += `<h2>å›å¤è¯æ¡ (${data.phrases.length}æ¡)</h2><ul>`;
            data.phrases.forEach(phrase => { html += `<li>${phrase}</li>`; });
            html += `</ul>`;
        }
        
        if (data.tarotSettings?.customPhrases) {
            html += `<h2>å¡”ç½—ç‰Œå­—å¡ (${data.tarotSettings.customPhrases.length}å¼ ) ğŸ”®</h2>`;
            html += `<p>å¡”ç½—ç‰Œæ¨¡å¼: ${data.tarotSettings.enabled ? 'å¼€å¯' : 'å…³é—­'}, æ¯æ¬¡æŠ½å–: ${data.tarotSettings.drawCount}å¼ </p>`;
            html += `<ul>`;
            data.tarotSettings.customPhrases.forEach(phrase => { html += `<li>${phrase}</li>`; });
            html += `</ul>`;
        }
        
        html += `</body></html>`;
        return html;
    }
    
    getFormattedDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}${month}${day}_${hours}${minutes}`;
    }
    
    downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆé‡ç½®åŠŸèƒ½ï¼‰
     */
    clearAllData() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ã€è®¾ç½®å’Œè¡¨æƒ…åŒ…ï¼Œä¸”ä¸å¯æ¢å¤ã€‚')) {
            this.dataManager.clearAllData();
            
            // é‡æ–°ä»localStorageåŠ è½½
            this.loadAllData();
            this.renderAllUI();
            
            this.showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼Œå·²æ¢å¤é»˜è®¤è®¾ç½®');
            this.closeSettingsPanel();
        }
    }
    
    // ========================
    // äº‹ä»¶ç›‘å¬è®¾ç½®
    // ========================
    
    setupEventListeners() {
        // å‘é€æ¶ˆæ¯
        const sendBtn = document.getElementById('sendButton');
        if (sendBtn) sendBtn.addEventListener('click', () => this.sendMessage());
        
        const input = document.getElementById('messageInput');
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.sendMessage();
            });
        }
        
        // ç»§ç»­æŒ‰é’®
        const continueBtn = document.getElementById('continueButton');
        if (continueBtn) {
            continueBtn.addEventListener('click', () => this.requestContinueMessages());
        }
        
        // å›¾ç‰‡ä¸Šä¼ 
        const uploadBtn = document.getElementById('uploadImageButton');
        const imageUpload = document.getElementById('imageUpload');
        if (uploadBtn && imageUpload) {
            uploadBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', (e) => this.handleImageUpload(e));
        }
        
        // è®¾ç½®é¢æ¿
        const settingsToggle = document.getElementById('settingsToggle');
        if (settingsToggle) {
            settingsToggle.addEventListener('click', () => this.openSettings());
        }
        
        const overlay = document.getElementById('settingsOverlay');
        if (overlay) {
            overlay.addEventListener('click', () => this.closeSettingsPanel());
        }
        
        const closeSettings = document.getElementById('closeSettings');
        if (closeSettings) {
            closeSettings.addEventListener('click', () => this.closeSettingsPanel());
        }
        
        // è¡¨æƒ…åŒ…
        const addStickerBtn = document.getElementById('addStickerBtn');
        const stickerUpload = document.getElementById('stickerUpload');
        if (addStickerBtn && stickerUpload) {
            addStickerBtn.addEventListener('click', () => stickerUpload.click());
            stickerUpload.addEventListener('change', (e) => this.handleStickerUpload(e));
        }
        
        // è¯æ¡ä¿å­˜
        const savePhrasesBtn = document.getElementById('savePhrasesBtn');
        if (savePhrasesBtn) {
            savePhrasesBtn.addEventListener('click', () => this.savePhrases());
        }
        
        // å¡”ç½—ç‰Œ
        const tarotModeToggle = document.getElementById('tarotModeToggle');
        if (tarotModeToggle) {
            tarotModeToggle.addEventListener('change', () => {
                if (!this.appData.tarotSettings) {
                    this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
                }
                this.appData.tarotSettings.enabled = tarotModeToggle.checked;
                this.updateTarotStatus();
                this.saveAllData();
                this.showNotification(`å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼ ${this.appData.tarotSettings.enabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'}`);
            });
        }
        
        const saveTarotBtn = document.getElementById('saveTarotBtn');
        if (saveTarotBtn) {
            saveTarotBtn.addEventListener('click', () => this.saveTarotSettings());
        }
        
        const tarotTextarea = document.getElementById('tarotTextarea');
        if (tarotTextarea) {
            tarotTextarea.addEventListener('input', () => this.updateTarotPhraseCount());
        }
        
        const loadDefaultTarotBtn = document.getElementById('loadDefaultTarotBtn');
        if (loadDefaultTarotBtn) {
            loadDefaultTarotBtn.addEventListener('click', () => this.loadDefaultTarotCards());
        }
        
        const clearTarotBtn = document.getElementById('clearTarotBtn');
        if (clearTarotBtn) {
            clearTarotBtn.addEventListener('click', () => this.clearTarotCards());
        }
        
        // èƒŒæ™¯
        const uploadBackgroundOption = document.getElementById('uploadBackgroundOption');
        const backgroundUpload = document.getElementById('backgroundUpload');
        if (uploadBackgroundOption && backgroundUpload) {
            uploadBackgroundOption.addEventListener('click', () => backgroundUpload.click());
            backgroundUpload.addEventListener('change', (e) => this.handleBackgroundUpload(e));
        }
        
        const removeBackgroundBtn = document.getElementById('removeBackgroundBtn');
        if (removeBackgroundBtn) {
            removeBackgroundBtn.addEventListener('click', () => this.removeBackground());
        }
        
        const bgOpacitySlider = document.getElementById('backgroundOpacitySlider');
        if (bgOpacitySlider) {
            bgOpacitySlider.addEventListener('input', (e) => {
                const value = e.target.value;
                const display = document.getElementById('backgroundOpacityValue');
                if (display) display.textContent = `${value}%`;
                if (this.appData.backgroundSettings) {
                    this.appData.backgroundSettings.opacity = parseInt(value);
                    this.applyBackgroundSettings();
                }
            });
        }
        
        const saveBackgroundBtn = document.getElementById('saveBackgroundBtn');
        if (saveBackgroundBtn) {
            saveBackgroundBtn.addEventListener('click', () => this.saveBackgroundSettings());
        }
        
        // æ ‡ç­¾é¡µ
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                this.switchTab(tabId);
            });
        });
        
        // å‘é€è®¾ç½®
        const stickerRatioSlider = document.getElementById('stickerRatioSlider');
        if (stickerRatioSlider) {
            stickerRatioSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                const display = document.getElementById('stickerRatioValue');
                if (display) display.textContent = `${value}%`;
                
                if (!this.appData.sendSettings) {
                    this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                }
                this.appData.sendSettings.stickerRatio = value;
                this.appData.sendSettings.phraseRatio = 100 - value;
                
                const phraseSlider = document.getElementById('phraseRatioSlider');
                const phraseDisplay = document.getElementById('phraseRatioValue');
                if (phraseSlider) phraseSlider.value = 100 - value;
                if (phraseDisplay) phraseDisplay.textContent = `${100 - value}%`;
                
                this.saveAllData();
            });
        }
        
        const phraseRatioSlider = document.getElementById('phraseRatioSlider');
        if (phraseRatioSlider) {
            phraseRatioSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                const display = document.getElementById('phraseRatioValue');
                if (display) display.textContent = `${value}%`;
                
                if (!this.appData.sendSettings) {
                    this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                }
                this.appData.sendSettings.phraseRatio = value;
                this.appData.sendSettings.stickerRatio = 100 - value;
                
                const stickerSlider = document.getElementById('stickerRatioSlider');
                const stickerDisplay = document.getElementById('stickerRatioValue');
                if (stickerSlider) stickerSlider.value = 100 - value;
                if (stickerDisplay) stickerDisplay.textContent = `${100 - value}%`;
                
                this.saveAllData();
            });
        }
        
        const maxMessageCount = document.getElementById('maxMessageCount');
        if (maxMessageCount) {
            maxMessageCount.addEventListener('change', (e) => {
                if (!this.appData.sendSettings) {
                    this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                }
                this.appData.sendSettings.maxMessageCount = parseInt(e.target.value);
                this.saveAllData();
            });
        }
        
        const autoSendFrequency = document.getElementById('autoSendFrequency');
        if (autoSendFrequency) {
            autoSendFrequency.addEventListener('change', (e) => {
                if (!this.appData.sendSettings) {
                    this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                }
                this.appData.sendSettings.autoSendFrequency = parseInt(e.target.value);
                this.restartAutoSending();
                this.saveAllData();
            });
        }
        
        // å¤–è§‚è®¾ç½®
        const saveAppearanceBtn = document.getElementById('saveAppearanceBtn');
        if (saveAppearanceBtn) {
            saveAppearanceBtn.addEventListener('click', () => this.saveAppearanceSettings());
        }
        
        const loveDays = document.getElementById('loveDays');
        if (loveDays) {
            loveDays.addEventListener('click', () => this.switchTab('appearance'));
        }
        
        // é€šä¿¡è®¾ç½®
        const startCallButton = document.getElementById('startCallButton');
        if (startCallButton) {
            startCallButton.addEventListener('click', () => this.startCall());
        }
        
        const startVideoButton = document.getElementById('startVideoButton');
        if (startVideoButton) {
            startVideoButton.addEventListener('click', () => this.startVideo());
        }
        
        const autoAcceptCalls = document.getElementById('autoAcceptCalls');
        if (autoAcceptCalls) {
            autoAcceptCalls.addEventListener('change', (e) => {
                if (!this.appData.communicationSettings) {
                    this.appData.communicationSettings = { autoAcceptCalls: true };
                }
                this.appData.communicationSettings.autoAcceptCalls = e.target.checked;
                this.saveAllData();
            });
        }
        
        const autoAcceptVideos = document.getElementById('autoAcceptVideos');
        if (autoAcceptVideos) {
            autoAcceptVideos.addEventListener('change', (e) => {
                if (!this.appData.communicationSettings) {
                    this.appData.communicationSettings = { autoAcceptVideos: true };
                }
                this.appData.communicationSettings.autoAcceptVideos = e.target.checked;
                this.saveAllData();
            });
        }
        
        const saveCommunicationBtn = document.getElementById('saveCommunicationBtn');
        if (saveCommunicationBtn) {
            saveCommunicationBtn.addEventListener('click', () => this.saveCommunicationSettings());
        }
        
        // ä¸»åŠ¨å‘¼å«è®¾ç½®
        const overallFreqSlider = document.getElementById('overallFrequencySlider');
        if (overallFreqSlider) {
            overallFreqSlider.addEventListener('input', () => this.updateOverallFrequency());
        }
        
        const callPrefSlider = document.getElementById('callPreferenceSlider');
        if (callPrefSlider) {
            callPrefSlider.addEventListener('input', () => this.updateCallPreference());
        }
        
        const presetBtns = document.querySelectorAll('.preset-btn');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const preset = e.currentTarget.getAttribute('data-preset');
                this.applyPresetMode(preset);
            });
        });
        
        // äº‘å¯¼å…¥
        const importCloudBtn = document.getElementById('importCloudBtn');
        if (importCloudBtn) {
            importCloudBtn.addEventListener('click', () => this.importCloudData());
        }
        
        const clearCloudBtn = document.getElementById('clearCloudBtn');
        if (clearCloudBtn) {
            clearCloudBtn.addEventListener('click', () => this.clearCloudTextarea());
        }
        
        const importFileBtn = document.getElementById('importFileBtn');
        const cloudFileUpload = document.getElementById('cloudFileUpload');
        if (importFileBtn && cloudFileUpload) {
            importFileBtn.addEventListener('click', () => cloudFileUpload.click());
            cloudFileUpload.addEventListener('change', (e) => this.handleCloudFileUpload(e));
        }
        
        // å¯¼å‡º
        const exportTxtBtn = document.getElementById('exportTxtBtn');
        if (exportTxtBtn) {
            exportTxtBtn.addEventListener('click', () => this.exportChatHistory('txt'));
        }
        
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        if (exportJsonBtn) {
            exportJsonBtn.addEventListener('click', () => this.exportChatHistory('json'));
        }
        
        const exportHtmlBtn = document.getElementById('exportHtmlBtn');
        if (exportHtmlBtn) {
            exportHtmlBtn.addEventListener('click', () => this.exportChatHistory('html'));
        }
        
        const exportAllBtn = document.getElementById('exportAllBtn');
        if (exportAllBtn) {
            exportAllBtn.addEventListener('click', () => this.exportAllData());
        }
        
        // ç”¨æˆ·ä¿¡æ¯
        const selfUserInfo = document.getElementById('selfUserInfo');
        if (selfUserInfo) {
            selfUserInfo.addEventListener('click', () => this.openUserEditModal('self'));
        }
        
        const otherUserInfo = document.getElementById('otherUserInfo');
        if (otherUserInfo) {
            otherUserInfo.addEventListener('click', () => this.openUserEditModal('other'));
        }
        
        // æ¨¡æ€æ¡†
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', () => this.closeUserEditModal());
        }
        
        const saveUserInfoBtn = document.getElementById('saveUserInfoBtn');
        if (saveUserInfoBtn) {
            saveUserInfoBtn.addEventListener('click', () => this.saveUserInfo());
        }
        
        const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
        const modalAvatarUpload = document.getElementById('modalAvatarUpload');
        if (uploadAvatarBtn && modalAvatarUpload) {
            uploadAvatarBtn.addEventListener('click', () => modalAvatarUpload.click());
            modalAvatarUpload.addEventListener('change', (e) => this.handleAvatarUpload(e));
        }
        
        // æ•°æ®ç®¡ç†ï¼ˆæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼‰
        const clearAllDataBtn = document.createElement('button');
        clearAllDataBtn.className = 'remove-background-btn';
        clearAllDataBtn.style.marginTop = '20px';
        clearAllDataBtn.style.background = '#d32f2f';
        clearAllDataBtn.innerHTML = '<i class="material-icons">delete_forever</i> æ¸…é™¤æ‰€æœ‰æ•°æ®';
        clearAllDataBtn.addEventListener('click', () => this.clearAllData());
        
        // æ·»åŠ åˆ°å¯¼å‡ºæ ‡ç­¾é¡µ
        const exportTab = document.getElementById('exportTab');
        if (exportTab) {
            const existingBtn = exportTab.querySelector('.clear-all-data-btn');
            if (!existingBtn) {
                clearAllDataBtn.classList.add('clear-all-data-btn');
                exportTab.appendChild(clearAllDataBtn);
            }
        }
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ¶ˆæ¯æ“ä½œèœå•
        document.addEventListener('click', (e) => {
            if (this.appData.activeMessageActions && 
                !this.appData.activeMessageActions.contains(e.target) &&
                !e.target.closest('.message')) {
                this.appData.activeMessageActions.style.display = 'none';
                this.appData.activeMessageActions = null;
            }
        });
    }
    
    restartAutoSending() {
        if (this.appData.autoSendTimer) {
            clearInterval(this.appData.autoSendTimer);
        }
        this.startAutoSending();
    }
    
    requestContinueMessages() {
        this.appData.isTyping = true;
        this.renderMessages();
        
        setTimeout(() => {
            this.appData.isTyping = false;
            
            if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                this.generateTarotReply('continue');
                this.showNotification(`å¯¹æ–¹æŠ½å–äº†å¡”ç½—ç‰Œè¿›è¡Œå åœ ğŸ”®`);
            } else {
                const messageCount = Math.floor(Math.random() * 3) + 1;
                this.autoSendMessage();
                this.showNotification(`å¯¹æ–¹ç»§ç»­å‘é€äº†${messageCount}æ¡æ¶ˆæ¯`);
            }
        }, 1000 + Math.random() * 2000);
    }
    
    // ========================
    // é€šçŸ¥
    // ========================
    
    showNotification(message) {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) notification.remove();
        }, 3000);
    }
}

// ========================
// å¯åŠ¨åº”ç”¨
// ========================
document.addEventListener('DOMContentLoaded', () => {
    window.chatApp = new ChatApp();
});
</script>
</body>
</html>